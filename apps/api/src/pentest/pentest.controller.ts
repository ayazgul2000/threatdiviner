import {
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Body,
  Param,
  Query,
  UseGuards,
  HttpCode,
  HttpStatus,
} from '@nestjs/common';
import { JwtAuthGuard } from '../libs/auth/guards/jwt-auth.guard';
import { CurrentUser } from '../libs/auth/decorators';
import { PenTestService } from './pentest.service';
import {
  CreateTargetDto,
  UpdateTargetDto,
  CreateScanDto,
  UpdateFindingStatusDto,
  TargetQueryDto,
  ScanQueryDto,
  FindingQueryDto,
} from './dto';

interface AuthUser {
  tenantId: string;
  userId: string;
  email: string;
}

@Controller('pentest')
@UseGuards(JwtAuthGuard)
export class PenTestController {
  constructor(private readonly penTestService: PenTestService) {}

  // ============ TARGETS ============

  @Get('targets')
  async getTargets(
    @CurrentUser() user: AuthUser,
    @Query() query: TargetQueryDto,
  ) {
    return this.penTestService.getTargets(user.tenantId, query);
  }

  @Get('targets/:id')
  async getTarget(
    @CurrentUser() user: AuthUser,
    @Param('id') id: string,
  ) {
    return this.penTestService.getTarget(user.tenantId, id);
  }

  @Post('targets')
  async createTarget(
    @CurrentUser() user: AuthUser,
    @Body() dto: CreateTargetDto,
  ) {
    return this.penTestService.createTarget(user.tenantId, dto);
  }

  @Put('targets/:id')
  async updateTarget(
    @CurrentUser() user: AuthUser,
    @Param('id') id: string,
    @Body() dto: UpdateTargetDto,
  ) {
    return this.penTestService.updateTarget(user.tenantId, id, dto);
  }

  @Delete('targets/:id')
  @HttpCode(HttpStatus.OK)
  async deleteTarget(
    @CurrentUser() user: AuthUser,
    @Param('id') id: string,
  ) {
    return this.penTestService.deleteTarget(user.tenantId, id);
  }

  // ============ SCANS ============

  @Get('scans')
  async getScans(
    @CurrentUser() user: AuthUser,
    @Query() query: ScanQueryDto,
  ) {
    return this.penTestService.getScans(user.tenantId, query);
  }

  @Get('scans/:id')
  async getScan(
    @CurrentUser() user: AuthUser,
    @Param('id') id: string,
  ) {
    return this.penTestService.getScan(user.tenantId, id);
  }

  @Post('scans')
  async createScan(
    @CurrentUser() user: AuthUser,
    @Body() dto: CreateScanDto,
  ) {
    return this.penTestService.createScan(user.tenantId, dto);
  }

  @Post('scans/:id/cancel')
  @HttpCode(HttpStatus.OK)
  async cancelScan(
    @CurrentUser() user: AuthUser,
    @Param('id') id: string,
  ) {
    return this.penTestService.cancelScan(user.tenantId, id);
  }

  // ============ FINDINGS ============

  @Get('findings')
  async getFindings(
    @CurrentUser() user: AuthUser,
    @Query() query: FindingQueryDto,
  ) {
    return this.penTestService.getFindings(user.tenantId, query);
  }

  @Get('findings/:id')
  async getFinding(
    @CurrentUser() user: AuthUser,
    @Param('id') id: string,
  ) {
    return this.penTestService.getFinding(user.tenantId, id);
  }

  @Put('findings/:id/status')
  async updateFindingStatus(
    @CurrentUser() user: AuthUser,
    @Param('id') id: string,
    @Body() dto: UpdateFindingStatusDto,
  ) {
    return this.penTestService.updateFindingStatus(user.tenantId, id, dto, user.userId);
  }

  // ============ SCANNER STATUS ============

  @Get('scanners/status')
  async getScannerStatus() {
    return this.penTestService.getScannerStatus();
  }

  // ============ TWO-PHASE SCANNING ============

  @Post('scans/full-analysis')
  async runFullAnalysis(
    @CurrentUser() user: AuthUser,
    @Body() body: { targetId: string; scanners?: string[] },
  ) {
    const result = await this.penTestService.runTwoPhase(
      user.tenantId,
      body.targetId,
      body.scanners,
    );

    return {
      ...result,
      phases: ['discovery', 'deep'],
      status: 'completed',
    };
  }

  @Get('scans/:id/technologies')
  async getScanTechnologies(
    @CurrentUser() user: AuthUser,
    @Param('id') id: string,
  ) {
    const scan = await this.penTestService.getScan(user.tenantId, id);
    return {
      scanId: id,
      detectedTechnologies: scan.detectedTechnologies || [],
      scanPhase: scan.scanPhase,
    };
  }

  // ============ RETRY FAILED TEMPLATES ============

  @Post('scans/:id/retry-templates')
  @HttpCode(HttpStatus.OK)
  async retryFailedTemplates(
    @CurrentUser() user: AuthUser,
    @Param('id') id: string,
    @Body() body: { templateIds: string[] },
  ) {
    return this.penTestService.retryFailedTemplates(
      user.tenantId,
      id,
      body.templateIds,
    );
  }
}
