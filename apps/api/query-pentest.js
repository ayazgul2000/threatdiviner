const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function main() {
  const scans = await prisma.penTestScan.findMany({
    orderBy: { createdAt: 'desc' },
    take: 5,
    include: {
      findings: {
        select: {
          id: true,
          scanner: true,
          severity: true,
          title: true,
        }
      }
    }
  });

  console.log('=== PENTEST/DAST SCANS ===');
  console.log('Total scans found:', scans.length);

  for (const scan of scans) {
    console.log('\n--- Scan', scan.id, '---');
    console.log('Target:', scan.targetUrl);
    console.log('Status:', scan.status);
    console.log('Scanners:', scan.scanners);
    console.log('Findings:', scan.findings.length);

    const byScanner = {};
    for (const f of scan.findings) {
      if (!byScanner[f.scanner]) byScanner[f.scanner] = [];
      byScanner[f.scanner].push(f);
    }

    for (const [scanner, findings] of Object.entries(byScanner)) {
      console.log('  ' + scanner + ': ' + findings.length + ' findings');
      const bySev = {};
      for (const f of findings) {
        bySev[f.severity] = (bySev[f.severity] || 0) + 1;
      }
      console.log('    Severity:', JSON.stringify(bySev));
    }
  }
}

main().catch(console.error).finally(() => prisma.$disconnect());
