generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  plan             String   @default("free") // free, pro, enterprise
  maxUsers         Int      @default(5) @map("max_users")
  maxRepositories  Int      @default(10) @map("max_repositories")
  aiTriageEnabled  Boolean  @default(false) @map("ai_triage_enabled")
  isActive         Boolean  @default(true) @map("is_active")
  // Retention policies
  scanRetentionDays     Int @default(90) @map("scan_retention_days")
  findingRetentionDays  Int @default(365) @map("finding_retention_days")
  auditRetentionDays    Int @default(90) @map("audit_retention_days")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  users              User[]
  scmConnections     ScmConnection[]
  repositories       Repository[]
  scanConfigs        ScanConfig[]
  scans              Scan[]
  findings           Finding[]
  notificationConfig NotificationConfig?
  jiraConfig         JiraConfig?
  findingBaselines   FindingBaseline[]
  apiKeys            ApiKey[]

  @@map("tenants")
}

model User {
  id           String    @id @default(uuid())
  tenantId     String    @map("tenant_id")
  email        String
  name         String?
  passwordHash String?   @map("password_hash")
  role         String    @default("member")
  status       String    @default("active") // active, invited, disabled
  inviteToken  String?   @unique @map("invite_token")
  invitedBy    String?   @map("invited_by")
  invitedAt    DateTime? @map("invited_at")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  apiKeys ApiKey[]

  @@unique([tenantId, email])
  @@map("users")
}

// SCM provider connection (OAuth or PAT)
model ScmConnection {
  id             String    @id @default(uuid())
  tenantId       String    @map("tenant_id")
  provider       String // github, gitlab, bitbucket
  authMethod     String    @map("auth_method") // oauth, pat, github_app
  accessToken    String    @map("access_token") // encrypted at rest
  refreshToken   String?   @map("refresh_token") // encrypted, for OAuth refresh
  tokenExpiresAt DateTime? @map("token_expires_at")
  installationId String?   @map("installation_id") // GitHub App installation ID
  externalId     String    @map("external_id") // provider's user/org ID
  externalName   String    @map("external_name") // username or org name
  scope          String[] // permissions granted
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  repositories Repository[]

  @@unique([tenantId, provider, externalId])
  @@index([tenantId])
  @@map("scm_connections")
}

// Repository to scan
model Repository {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  connectionId  String    @map("connection_id")
  name          String // repo name
  fullName      String    @map("full_name") // owner/repo
  cloneUrl      String    @map("clone_url")
  htmlUrl       String    @map("html_url") // web URL
  defaultBranch String    @default("main") @map("default_branch")
  language      String? // primary language
  isPrivate     Boolean   @default(true) @map("is_private")
  isActive      Boolean   @default(true) @map("is_active")
  lastScanAt    DateTime? @map("last_scan_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connection       ScmConnection     @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  scanConfig       ScanConfig?
  scans            Scan[]
  findingBaselines FindingBaseline[]

  @@unique([tenantId, fullName])
  @@index([tenantId])
  @@index([connectionId])
  @@map("repositories")
}

// Per-repo scan settings
model ScanConfig {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  repositoryId  String   @unique @map("repository_id")
  enableSast    Boolean  @default(true) @map("enable_sast")
  enableSca     Boolean  @default(true) @map("enable_sca")
  enableSecrets Boolean  @default(true) @map("enable_secrets")
  enableIac     Boolean  @default(true) @map("enable_iac")
  enableDast          Boolean  @default(false) @map("enable_dast") // requires URL
  enableContainerScan Boolean  @default(false) @map("enable_container_scan")
  targetUrls          String[] @default([]) @map("target_urls") // DAST target URLs
  containerImages     String[] @default([]) @map("container_images") // Container images to scan
  branches            String[] @default(["main", "master"])
  autoScanOnPush      Boolean  @default(true) @map("auto_scan_on_push")
  autoScanOnPR        Boolean  @default(true) @map("auto_scan_on_pr")
  skipPaths     String[] @default(["node_modules", "vendor", ".git"]) @map("skip_paths")
  customRules   Json?    @map("custom_rules") // Semgrep custom rules etc
  // Scheduled scanning
  scheduleEnabled     Boolean  @default(false) @map("schedule_enabled")
  scheduleCron        String?  @map("schedule_cron") // e.g., "0 2 * * *" (2am daily)
  scheduleTimezone    String   @default("UTC") @map("schedule_timezone")
  lastScheduledScan   DateTime? @map("last_scheduled_scan")
  nextScheduledScan   DateTime? @map("next_scheduled_scan")
  // PR comment settings
  prCommentsEnabled   Boolean  @default(true) @map("pr_comments_enabled")
  prCommentMaxFindings Int     @default(20) @map("pr_comment_max_findings")
  prCommentSeverities String[] @default(["critical", "high", "medium"]) @map("pr_comment_severities")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("scan_configs")
}

// Individual scan run
model Scan {
  id             String    @id @default(uuid())
  tenantId       String    @map("tenant_id")
  repositoryId   String    @map("repository_id")
  commitSha      String    @map("commit_sha")
  branch         String
  status         String    @default("pending") // pending, cloning, scanning, analyzing, completed, failed
  triggeredBy    String    @map("triggered_by") // webhook, manual, scheduled
  triggerEvent   String?   @map("trigger_event") // push, pull_request, workflow_dispatch
  pullRequestId  String?   @map("pull_request_id") // PR number if triggered by PR
  pullRequestUrl String?   @map("pull_request_url")
  checkRunId     String?   @map("check_run_id") // GitHub check run ID for status updates
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  duration       Int? // seconds
  errorMessage   String?   @map("error_message")
  createdAt      DateTime  @default(now()) @map("created_at")

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  findings   Finding[]

  @@index([tenantId])
  @@index([repositoryId])
  @@index([status])
  @@map("scans")
}

// Vulnerability/issue found by scanner
model Finding {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  scanId        String    @map("scan_id")
  repositoryId  String    @map("repository_id")
  scanner       String // semgrep, trivy, gitleaks, checkov, etc
  ruleId        String    @map("rule_id") // scanner's rule identifier
  severity      String // critical, high, medium, low, info
  title         String
  description   String?
  filePath      String    @map("file_path")
  startLine     Int?      @map("start_line")
  endLine       Int?      @map("end_line")
  snippet       String? // code snippet
  cweId         String?   @map("cwe_id") // CWE-79, etc
  cveId         String?   @map("cve_id") // CVE-2024-xxxx
  owasp         String? // A01:2021, etc
  confidence    String? // high, medium, low
  status        String    @default("open") // open, triaged, fixed, false_positive, accepted, baselined
  triagedBy     String?   @map("triaged_by") // user ID who triaged
  triagedAt     DateTime? @map("triaged_at")
  fixedInCommit String?   @map("fixed_in_commit")
  // Fingerprint for deduplication and baseline matching
  fingerprint   String?   // Unique identifier: hash of (ruleId + filePath + snippet)
  // Jira integration
  jiraIssueKey  String?   @map("jira_issue_key") // e.g., SEC-123
  jiraIssueUrl  String?   @map("jira_issue_url")
  // AI triage fields
  aiAnalysis       String?   @map("ai_analysis") // Claude's assessment
  aiConfidence     Float?    @map("ai_confidence") // AI confidence score 0-1
  aiSeverity       String?   @map("ai_severity") // AI-suggested severity
  aiFalsePositive  Boolean?  @map("ai_false_positive") // AI thinks it's a false positive
  aiExploitability String?   @map("ai_exploitability") // high, medium, low, none
  aiRemediation    String?   @map("ai_remediation") // AI-suggested fix
  aiTriagedAt      DateTime? @map("ai_triaged_at") // When AI triaged
  firstSeenAt      DateTime  @default(now()) @map("first_seen_at") // First occurrence
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  scan   Scan   @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([scanId])
  @@index([repositoryId])
  @@index([severity])
  @@index([status])
  @@index([fingerprint])
  @@map("findings")
}

// Webhook audit log
model WebhookEvent {
  id          String    @id @default(uuid())
  tenantId    String?   @map("tenant_id") // nullable - may not know tenant yet
  provider    String // github, gitlab, bitbucket
  eventType   String    @map("event_type") // push, pull_request, installation
  deliveryId  String?   @map("delivery_id") // provider's delivery ID
  signature   String // for verification
  payload     Json // raw webhook body (sanitized)
  processed   Boolean   @default(false)
  processedAt DateTime? @map("processed_at")
  error       String?
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([provider, deliveryId])
  @@index([processed])
  @@map("webhook_events")
}

// Notification settings per tenant
model NotificationConfig {
  id                   String   @id @default(uuid())
  tenantId             String   @unique @map("tenant_id")
  // Slack settings
  slackWebhookUrl      String?  @map("slack_webhook_url") // Encrypted
  slackChannel         String?  @map("slack_channel")
  slackEnabled         Boolean  @default(false) @map("slack_enabled")
  // Email settings
  emailEnabled         Boolean  @default(false) @map("email_enabled")
  emailRecipients      String[] @default([]) @map("email_recipients")
  // Notification triggers
  notifyOnScanStart    Boolean  @default(false) @map("notify_on_scan_start")
  notifyOnScanComplete Boolean  @default(true) @map("notify_on_scan_complete")
  notifyOnCritical     Boolean  @default(true) @map("notify_on_critical")
  notifyOnHigh         Boolean  @default(false) @map("notify_on_high")
  weeklyDigestEnabled  Boolean  @default(false) @map("weekly_digest_enabled")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("notification_configs")
}

// Platform-wide configuration (for admin portal)
model PlatformConfig {
  id                     String   @id @default(uuid())
  aiProvider             String   @default("anthropic") @map("ai_provider")
  aiModel                String   @default("claude-sonnet-4-20250514") @map("ai_model")
  aiApiKey               String?  @map("ai_api_key") // Encrypted
  defaultPlan            String   @default("free") @map("default_plan")
  defaultMaxUsers        Int      @default(5) @map("default_max_users")
  defaultMaxRepositories Int      @default(10) @map("default_max_repositories")
  maintenanceMode        Boolean  @default(false) @map("maintenance_mode")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@map("platform_config")
}

// Audit log for tracking important actions
model AuditLog {
  id          String    @id @default(uuid())
  tenantId    String?   @map("tenant_id")
  userId      String?   @map("user_id")
  userEmail   String?   @map("user_email")
  action      String    // e.g., 'scan.trigger', 'finding.status_change', 'user.invite'
  resource    String    // e.g., 'scan', 'finding', 'user', 'repository'
  resourceId  String?   @map("resource_id")
  details     Json?     // Additional context about the action
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// Platform administrator accounts
model PlatformAdmin {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  isSuperAdmin Boolean   @default(false) @map("is_super_admin")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("platform_admins")
}

// Jira integration configuration per tenant
model JiraConfig {
  id                   String   @id @default(uuid())
  tenantId             String   @unique @map("tenant_id")
  jiraUrl              String   @map("jira_url") // e.g., https://company.atlassian.net
  email                String   // Jira account email
  apiToken             String   @map("api_token") // Encrypted API token
  projectKey           String   @map("project_key") // Default project key (e.g., SEC)
  issueType            String   @default("Bug") @map("issue_type")
  enabled              Boolean  @default(false)
  autoCreate           Boolean  @default(false) @map("auto_create") // Auto-create for critical/high
  autoCreateSeverities String[] @default(["critical", "high"]) @map("auto_create_severities")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("jira_configs")
}

// Baseline for suppressing known/accepted findings
model FindingBaseline {
  id           String    @id @default(uuid())
  tenantId     String    @map("tenant_id")
  repositoryId String    @map("repository_id")
  fingerprint  String    // Unique finding identifier
  reason       String    // Why it's baselined
  baselinedBy  String    @map("baselined_by") // User ID
  expiresAt    DateTime? @map("expires_at") // Optional expiry
  createdAt    DateTime  @default(now()) @map("created_at")

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@unique([tenantId, repositoryId, fingerprint])
  @@index([tenantId])
  @@index([repositoryId])
  @@map("finding_baselines")
}

// API keys for programmatic access
model ApiKey {
  id         String    @id @default(uuid())
  tenantId   String    @map("tenant_id")
  userId     String    @map("user_id")
  name       String    // "CI/CD Key", "Jenkins", etc.
  keyHash    String    @map("key_hash") // SHA256 hash of the key
  keyPrefix  String    @map("key_prefix") // First 8 chars for display: "td_abc123..."
  scopes     String[]  // ["scans:trigger", "findings:read"]
  expiresAt  DateTime? @map("expires_at")
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([tenantId])
  @@index([userId])
  @@map("api_keys")
}

// Cloud account for CSPM scanning
model CloudAccount {
  id           String    @id @default(uuid())
  tenantId     String    @map("tenant_id")
  provider     String    // aws, azure, gcp
  name         String
  accountId    String    @map("account_id") // AWS account ID, Azure subscription, GCP project
  credentials  Json      // Encrypted credentials
  regions      String[]  @default([])
  enabled      Boolean   @default(true)
  lastScanAt   DateTime? @map("last_scan_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  findings CspmFinding[]

  @@unique([tenantId, provider, accountId])
  @@index([tenantId])
  @@map("cloud_accounts")
}

// CSPM finding from cloud security scan
model CspmFinding {
  id           String   @id @default(uuid())
  accountId    String   @map("account_id")
  provider     String   // aws, azure, gcp
  service      String   // s3, ec2, iam, etc
  region       String
  resourceId   String   @map("resource_id")
  resourceType String   @map("resource_type")
  severity     String   // critical, high, medium, low, info
  title        String
  description  String
  remediation  String?
  compliance   String[] @default([]) // Compliance frameworks affected
  status       String   @default("open") // open, resolved, suppressed
  firstSeenAt  DateTime @default(now()) @map("first_seen_at")
  lastSeenAt   DateTime @default(now()) @map("last_seen_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  account CloudAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([severity])
  @@index([status])
  @@index([service])
  @@map("cspm_findings")
}

// SIEM alert rule
model AlertRule {
  id                 String    @id @default(uuid())
  tenantId           String    @map("tenant_id")
  name               String
  description        String?
  enabled            Boolean   @default(true)
  // Conditions
  eventTypes         String[]  @default([]) @map("event_types")
  sources            String[]  @default([])
  severities         String[]  @default([])
  titlePattern       String?   @map("title_pattern")
  // Thresholds
  threshold          Int       @default(1)
  timeWindowMinutes  Int       @default(5) @map("time_window_minutes")
  // Actions
  notifySlack        Boolean   @default(false) @map("notify_slack")
  notifyEmail        Boolean   @default(true) @map("notify_email")
  createJiraIssue    Boolean   @default(false) @map("create_jira_issue")
  // Tracking
  lastTriggeredAt    DateTime? @map("last_triggered_at")
  triggerCount       Int       @default(0) @map("trigger_count")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  history AlertHistory[]

  @@index([tenantId])
  @@index([enabled])
  @@map("alert_rules")
}

// Alert trigger history
model AlertHistory {
  id            String   @id @default(uuid())
  ruleId        String   @map("rule_id")
  tenantId      String   @map("tenant_id")
  matchedEvents Int      @map("matched_events")
  sampleEvents  Json     @map("sample_events")
  triggeredAt   DateTime @map("triggered_at")
  createdAt     DateTime @default(now()) @map("created_at")

  rule AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([ruleId])
  @@index([triggeredAt])
  @@map("alert_history")
}
