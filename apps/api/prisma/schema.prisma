generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  plan             String   @default("free") // free, pro, enterprise
  maxUsers         Int      @default(5) @map("max_users")
  maxRepositories  Int      @default(10) @map("max_repositories")
  aiTriageEnabled  Boolean  @default(false) @map("ai_triage_enabled")
  isActive         Boolean  @default(true) @map("is_active")
  // Retention policies
  scanRetentionDays     Int @default(90) @map("scan_retention_days")
  findingRetentionDays  Int @default(365) @map("finding_retention_days")
  auditRetentionDays    Int @default(90) @map("audit_retention_days")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  users              User[]
  scmConnections     ScmConnection[]
  repositories       Repository[]
  scanConfigs        ScanConfig[]
  scans              Scan[]
  findings           Finding[]
  notificationConfig NotificationConfig?
  jiraConfig         JiraConfig?
  findingBaselines   FindingBaseline[]
  apiKeys            ApiKey[]

  @@map("tenants")
}

model User {
  id           String    @id @default(uuid())
  tenantId     String    @map("tenant_id")
  email        String
  name         String?
  passwordHash String?   @map("password_hash")
  role         String    @default("member")
  status       String    @default("active") // active, invited, disabled
  inviteToken  String?   @unique @map("invite_token")
  invitedBy    String?   @map("invited_by")
  invitedAt    DateTime? @map("invited_at")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  apiKeys ApiKey[]

  @@unique([tenantId, email])
  @@map("users")
}

// SCM provider connection (OAuth or PAT)
model ScmConnection {
  id             String    @id @default(uuid())
  tenantId       String    @map("tenant_id")
  provider       String // github, gitlab, bitbucket
  authMethod     String    @map("auth_method") // oauth, pat, github_app
  accessToken    String    @map("access_token") // encrypted at rest
  refreshToken   String?   @map("refresh_token") // encrypted, for OAuth refresh
  tokenExpiresAt DateTime? @map("token_expires_at")
  installationId String?   @map("installation_id") // GitHub App installation ID
  externalId     String    @map("external_id") // provider's user/org ID
  externalName   String    @map("external_name") // username or org name
  scope          String[] // permissions granted
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  repositories Repository[]

  @@unique([tenantId, provider, externalId])
  @@index([tenantId])
  @@map("scm_connections")
}

// Repository to scan
model Repository {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  connectionId  String    @map("connection_id")
  name          String // repo name
  fullName      String    @map("full_name") // owner/repo
  cloneUrl      String    @map("clone_url")
  htmlUrl       String    @map("html_url") // web URL
  defaultBranch String    @default("main") @map("default_branch")
  language      String? // primary language
  isPrivate     Boolean   @default(true) @map("is_private")
  isActive      Boolean   @default(true) @map("is_active")
  lastScanAt    DateTime? @map("last_scan_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connection       ScmConnection     @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  scanConfig       ScanConfig?
  scans            Scan[]
  findingBaselines FindingBaseline[]

  @@unique([tenantId, fullName])
  @@index([tenantId])
  @@index([connectionId])
  @@map("repositories")
}

// Per-repo scan settings
model ScanConfig {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  repositoryId  String   @unique @map("repository_id")
  enableSast    Boolean  @default(true) @map("enable_sast")
  enableSca     Boolean  @default(true) @map("enable_sca")
  enableSecrets Boolean  @default(true) @map("enable_secrets")
  enableIac     Boolean  @default(true) @map("enable_iac")
  enableDast          Boolean  @default(false) @map("enable_dast") // requires URL
  enableContainerScan Boolean  @default(false) @map("enable_container_scan")
  targetUrls          String[] @default([]) @map("target_urls") // DAST target URLs
  containerImages     String[] @default([]) @map("container_images") // Container images to scan
  branches            String[] @default(["main", "master"])
  autoScanOnPush      Boolean  @default(true) @map("auto_scan_on_push")
  autoScanOnPR        Boolean  @default(true) @map("auto_scan_on_pr")
  skipPaths     String[] @default(["node_modules", "vendor", ".git"]) @map("skip_paths")
  customRules   Json?    @map("custom_rules") // Semgrep custom rules etc
  // Scheduled scanning
  scheduleEnabled     Boolean  @default(false) @map("schedule_enabled")
  scheduleCron        String?  @map("schedule_cron") // e.g., "0 2 * * *" (2am daily)
  scheduleTimezone    String   @default("UTC") @map("schedule_timezone")
  lastScheduledScan   DateTime? @map("last_scheduled_scan")
  nextScheduledScan   DateTime? @map("next_scheduled_scan")
  // PR comment settings
  prCommentsEnabled   Boolean  @default(true) @map("pr_comments_enabled")
  prCommentMaxFindings Int     @default(20) @map("pr_comment_max_findings")
  prCommentSeverities String[] @default(["critical", "high", "medium"]) @map("pr_comment_severities")
  prDiffOnly          Boolean  @default(true) @map("pr_diff_only") // Only post findings on changed lines
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("scan_configs")
}

// Individual scan run
model Scan {
  id             String    @id @default(uuid())
  tenantId       String    @map("tenant_id")
  repositoryId   String    @map("repository_id")
  commitSha      String    @map("commit_sha")
  branch         String
  status         String    @default("pending") // pending, cloning, scanning, analyzing, completed, failed
  triggeredBy    String    @map("triggered_by") // webhook, manual, scheduled
  triggerEvent   String?   @map("trigger_event") // push, pull_request, workflow_dispatch
  pullRequestId  String?   @map("pull_request_id") // PR number if triggered by PR
  pullRequestUrl String?   @map("pull_request_url")
  checkRunId     String?   @map("check_run_id") // GitHub check run ID for status updates
  sarifUploadId  String?   @map("sarif_upload_id") // SARIF upload ID for native security integration
  sarifUploadUrl String?   @map("sarif_upload_url") // URL to view in native security tab
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  duration       Int? // seconds
  errorMessage   String?   @map("error_message")
  createdAt      DateTime  @default(now()) @map("created_at")

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  findings   Finding[]

  @@index([tenantId])
  @@index([repositoryId])
  @@index([status])
  @@map("scans")
}

// Vulnerability/issue found by scanner
model Finding {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  scanId        String    @map("scan_id")
  repositoryId  String    @map("repository_id")
  scanner       String // semgrep, trivy, gitleaks, checkov, etc
  ruleId        String    @map("rule_id") // scanner's rule identifier
  severity      String // critical, high, medium, low, info
  title         String
  description   String?
  filePath      String    @map("file_path")
  startLine     Int?      @map("start_line")
  endLine       Int?      @map("end_line")
  snippet       String? // code snippet
  cweId         String?   @map("cwe_id") // CWE-79, etc
  cveId         String?   @map("cve_id") // CVE-2024-xxxx
  owasp         String? // A01:2021, etc
  confidence    String? // high, medium, low
  autoFix       String?   @map("auto_fix") // Suggested auto-fix code
  remediation   String?   // Remediation guidance
  status        String    @default("open") // open, triaged, fixed, false_positive, accepted, baselined
  dismissReason String?   @map("dismiss_reason") // Reason for dismissal
  dismissedAt   DateTime? @map("dismissed_at")
  prCommentId   String?   @map("pr_comment_id") // PR comment ID for resolving
  triagedBy     String?   @map("triaged_by") // user ID who triaged
  triagedAt     DateTime? @map("triaged_at")
  fixedInCommit String?   @map("fixed_in_commit")
  // Fingerprint for deduplication and baseline matching
  fingerprint   String?   // Unique identifier: hash of (ruleId + filePath + snippet)
  // Jira integration
  jiraIssueKey  String?   @map("jira_issue_key") // e.g., SEC-123
  jiraIssueUrl  String?   @map("jira_issue_url")
  // AI triage fields
  aiAnalysis       String?   @map("ai_analysis") // Claude's assessment
  aiConfidence     Float?    @map("ai_confidence") // AI confidence score 0-1
  aiSeverity       String?   @map("ai_severity") // AI-suggested severity
  aiFalsePositive  Boolean?  @map("ai_false_positive") // AI thinks it's a false positive
  aiExploitability String?   @map("ai_exploitability") // high, medium, low, none
  aiRemediation    String?   @map("ai_remediation") // AI-suggested fix
  aiTriagedAt      DateTime? @map("ai_triaged_at") // When AI triaged
  firstSeenAt      DateTime  @default(now()) @map("first_seen_at") // First occurrence
  // VulnDB enrichment fields
  cveData          Json?     @map("cve_data") // Cached CVE details
  cweData          Json?     @map("cwe_data") // Cached CWE details
  owaspCategory    String?   @map("owasp_category") // A01:2021
  complianceControls Json?   @map("compliance_controls") // Mapped compliance controls
  attackTechniques Json?     @map("attack_techniques") // MITRE ATT&CK techniques
  capecPatterns    Json?     @map("capec_patterns") // CAPEC attack patterns
  riskScore        Float?    @map("risk_score") // Calculated risk score
  isKev            Boolean   @default(false) @map("is_kev") // Known Exploited Vulnerability
  epssScore        Float?    @map("epss_score") // EPSS score from CVE
  enrichedAt       DateTime? @map("enriched_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  scan   Scan   @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([scanId])
  @@index([repositoryId])
  @@index([severity])
  @@index([status])
  @@index([fingerprint])
  @@map("findings")
}

// Webhook audit log
model WebhookEvent {
  id          String    @id @default(uuid())
  tenantId    String?   @map("tenant_id") // nullable - may not know tenant yet
  provider    String // github, gitlab, bitbucket
  eventType   String    @map("event_type") // push, pull_request, installation
  deliveryId  String?   @map("delivery_id") // provider's delivery ID
  signature   String // for verification
  payload     Json // raw webhook body (sanitized)
  processed   Boolean   @default(false)
  processedAt DateTime? @map("processed_at")
  error       String?
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([provider, deliveryId])
  @@index([processed])
  @@map("webhook_events")
}

// Notification settings per tenant
model NotificationConfig {
  id                   String   @id @default(uuid())
  tenantId             String   @unique @map("tenant_id")
  // Slack settings
  slackWebhookUrl      String?  @map("slack_webhook_url") // Encrypted
  slackChannel         String?  @map("slack_channel")
  slackEnabled         Boolean  @default(false) @map("slack_enabled")
  // Email settings
  emailEnabled         Boolean  @default(false) @map("email_enabled")
  emailRecipients      String[] @default([]) @map("email_recipients")
  // Notification triggers
  notifyOnScanStart    Boolean  @default(false) @map("notify_on_scan_start")
  notifyOnScanComplete Boolean  @default(true) @map("notify_on_scan_complete")
  notifyOnCritical     Boolean  @default(true) @map("notify_on_critical")
  notifyOnHigh         Boolean  @default(false) @map("notify_on_high")
  weeklyDigestEnabled  Boolean  @default(false) @map("weekly_digest_enabled")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("notification_configs")
}

// Platform-wide configuration (for admin portal)
model PlatformConfig {
  id                     String   @id @default(uuid())
  aiProvider             String   @default("anthropic") @map("ai_provider")
  aiModel                String   @default("claude-sonnet-4-20250514") @map("ai_model")
  aiApiKey               String?  @map("ai_api_key") // Encrypted
  defaultPlan            String   @default("free") @map("default_plan")
  defaultMaxUsers        Int      @default(5) @map("default_max_users")
  defaultMaxRepositories Int      @default(10) @map("default_max_repositories")
  maintenanceMode        Boolean  @default(false) @map("maintenance_mode")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@map("platform_config")
}

// Audit log for tracking important actions
model AuditLog {
  id          String    @id @default(uuid())
  tenantId    String?   @map("tenant_id")
  userId      String?   @map("user_id")
  userEmail   String?   @map("user_email")
  action      String    // e.g., 'scan.trigger', 'finding.status_change', 'user.invite'
  resource    String    // e.g., 'scan', 'finding', 'user', 'repository'
  resourceId  String?   @map("resource_id")
  details     Json?     // Additional context about the action
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// Platform administrator accounts
model PlatformAdmin {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  isSuperAdmin Boolean   @default(false) @map("is_super_admin")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("platform_admins")
}

// Jira integration configuration per tenant
model JiraConfig {
  id                   String   @id @default(uuid())
  tenantId             String   @unique @map("tenant_id")
  jiraUrl              String   @map("jira_url") // e.g., https://company.atlassian.net
  email                String   // Jira account email
  apiToken             String   @map("api_token") // Encrypted API token
  projectKey           String   @map("project_key") // Default project key (e.g., SEC)
  issueType            String   @default("Bug") @map("issue_type")
  enabled              Boolean  @default(false)
  autoCreate           Boolean  @default(false) @map("auto_create") // Auto-create for critical/high
  autoCreateSeverities String[] @default(["critical", "high"]) @map("auto_create_severities")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("jira_configs")
}

// Baseline for suppressing known/accepted findings
model FindingBaseline {
  id           String    @id @default(uuid())
  tenantId     String    @map("tenant_id")
  repositoryId String    @map("repository_id")
  fingerprint  String    // Unique finding identifier
  reason       String    // Why it's baselined
  baselinedBy  String    @map("baselined_by") // User ID
  expiresAt    DateTime? @map("expires_at") // Optional expiry
  createdAt    DateTime  @default(now()) @map("created_at")

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@unique([tenantId, repositoryId, fingerprint])
  @@index([tenantId])
  @@index([repositoryId])
  @@map("finding_baselines")
}

// API keys for programmatic access
model ApiKey {
  id         String    @id @default(uuid())
  tenantId   String    @map("tenant_id")
  userId     String    @map("user_id")
  name       String    // "CI/CD Key", "Jenkins", etc.
  keyHash    String    @map("key_hash") // SHA256 hash of the key
  keyPrefix  String    @map("key_prefix") // First 8 chars for display: "td_abc123..."
  scopes     String[]  // ["scans:trigger", "findings:read"]
  expiresAt  DateTime? @map("expires_at")
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([tenantId])
  @@index([userId])
  @@map("api_keys")
}

// Cloud account for CSPM scanning
model CloudAccount {
  id           String    @id @default(uuid())
  tenantId     String    @map("tenant_id")
  provider     String    // aws, azure, gcp
  name         String
  accountId    String    @map("account_id") // AWS account ID, Azure subscription, GCP project
  credentials  Json      // Encrypted credentials
  regions      String[]  @default([])
  enabled      Boolean   @default(true)
  lastScanAt   DateTime? @map("last_scan_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  findings CspmFinding[]

  @@unique([tenantId, provider, accountId])
  @@index([tenantId])
  @@map("cloud_accounts")
}

// CSPM finding from cloud security scan
model CspmFinding {
  id           String   @id @default(uuid())
  accountId    String   @map("account_id")
  provider     String   // aws, azure, gcp
  service      String   // s3, ec2, iam, etc
  region       String
  resourceId   String   @map("resource_id")
  resourceType String   @map("resource_type")
  severity     String   // critical, high, medium, low, info
  title        String
  description  String
  remediation  String?
  compliance   String[] @default([]) // Compliance frameworks affected
  status       String   @default("open") // open, resolved, suppressed
  firstSeenAt  DateTime @default(now()) @map("first_seen_at")
  lastSeenAt   DateTime @default(now()) @map("last_seen_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  account CloudAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([severity])
  @@index([status])
  @@index([service])
  @@map("cspm_findings")
}

// SIEM alert rule
model AlertRule {
  id                 String    @id @default(uuid())
  tenantId           String    @map("tenant_id")
  name               String
  description        String?
  enabled            Boolean   @default(true)
  // Conditions
  eventTypes         String[]  @default([]) @map("event_types")
  sources            String[]  @default([])
  severities         String[]  @default([])
  titlePattern       String?   @map("title_pattern")
  // Thresholds
  threshold          Int       @default(1)
  timeWindowMinutes  Int       @default(5) @map("time_window_minutes")
  // Actions
  notifySlack        Boolean   @default(false) @map("notify_slack")
  notifyEmail        Boolean   @default(true) @map("notify_email")
  createJiraIssue    Boolean   @default(false) @map("create_jira_issue")
  // Tracking
  lastTriggeredAt    DateTime? @map("last_triggered_at")
  triggerCount       Int       @default(0) @map("trigger_count")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  history AlertHistory[]

  @@index([tenantId])
  @@index([enabled])
  @@map("alert_rules")
}

// Alert trigger history
model AlertHistory {
  id            String   @id @default(uuid())
  ruleId        String   @map("rule_id")
  tenantId      String   @map("tenant_id")
  matchedEvents Int      @map("matched_events")
  sampleEvents  Json     @map("sample_events")
  triggeredAt   DateTime @map("triggered_at")
  createdAt     DateTime @default(now()) @map("created_at")

  rule AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([ruleId])
  @@index([triggeredAt])
  @@map("alert_history")
}

// Pipeline security gates configuration
model PipelineGate {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  repositoryId    String?   @map("repository_id") // null = default for tenant
  stage           String    // code, build, test, deploy, prod
  enabled         Boolean   @default(true)
  blockSeverity   String    @default("critical") @map("block_severity") // critical, high, medium, low, none
  notifyOnFailure Boolean   @default(true) @map("notify_on_failure")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([tenantId, repositoryId, stage])
  @@index([tenantId])
  @@index([repositoryId])
  @@map("pipeline_gates")
}

// Diff filter cache for PR scanning
model DiffCache {
  id            String   @id @default(uuid())
  scanId        String   @unique @map("scan_id")
  pullRequestId String   @map("pull_request_id")
  diffData      Json     @map("diff_data") // Cached PR diff hunks
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([scanId])
  @@map("diff_cache")
}

// ============================================
// VULNERABILITY DATABASE (VulnDB)
// ============================================

// CVE Database - synced from NVD
model Cve {
  id                String   @id // CVE-2024-12345
  description       String
  publishedDate     DateTime @map("published_date")
  lastModifiedDate  DateTime @map("last_modified_date")
  cvssV3Score       Float?   @map("cvss_v3_score")
  cvssV3Vector      String?  @map("cvss_v3_vector")
  cvssV3Severity    String?  @map("cvss_v3_severity") // CRITICAL, HIGH, MEDIUM, LOW
  cvssV2Score       Float?   @map("cvss_v2_score")
  cweIds            String[] @map("cwe_ids") // CWE-79, CWE-89
  references        Json     @default("[]") // Array of URLs
  affectedProducts  Json     @default("[]") @map("affected_products") // CPE data
  epssScore         Float?   @map("epss_score") // Exploit Prediction Scoring
  epssPercentile    Float?   @map("epss_percentile")
  isKev             Boolean  @default(false) @map("is_kev") // Known Exploited Vulnerability
  kevDateAdded      DateTime? @map("kev_date_added")
  kevDueDate        DateTime? @map("kev_due_date")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([cvssV3Severity])
  @@index([publishedDate])
  @@index([isKev])
  @@index([epssScore])
  @@map("cves")
}

// CWE Database - synced from MITRE
model Cwe {
  id                  String   @id // CWE-79
  name                String   // Cross-site Scripting
  description         String
  extendedDescription String?  @map("extended_description")
  relatedWeaknesses   String[] @map("related_weaknesses") // Parent/child CWEs
  commonConsequences  Json     @default("[]") @map("common_consequences")
  potentialMitigations Json    @default("[]") @map("potential_mitigations")
  detectionMethods    Json     @default("[]") @map("detection_methods")
  applicablePlatforms Json     @default("[]") @map("applicable_platforms")
  likelihoodOfExploit String?  @map("likelihood_of_exploit") // High, Medium, Low
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Compliance mappings
  complianceMappings CweComplianceMapping[]

  @@map("cwes")
}

// CWE to Compliance Control mapping
model CweComplianceMapping {
  id                 String  @id @default(uuid())
  cweId              String  @map("cwe_id")
  cwe                Cwe     @relation(fields: [cweId], references: [id], onDelete: Cascade)
  frameworkId        String  @map("framework_id") // soc2, pci-dss, hipaa, gdpr, iso27001, nist, cis, owasp
  controlId          String  @map("control_id") // CC6.1, 6.5.1, etc.
  controlName        String  @map("control_name")
  controlDescription String? @map("control_description")

  @@unique([cweId, frameworkId, controlId])
  @@index([frameworkId])
  @@index([cweId])
  @@map("cwe_compliance_mappings")
}

// Compliance Framework definitions
model ComplianceFramework {
  id          String   @id // soc2, pci-dss, hipaa, etc.
  name        String   // SOC 2 Type II
  version     String   // 2017, 4.0, etc.
  description String
  sourceUrl   String   @map("source_url") // Official documentation URL
  lastUpdated DateTime @map("last_updated")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  controls    ComplianceControl[]

  @@map("compliance_frameworks")
}

model ComplianceControl {
  id             String   @id @default(uuid())
  frameworkId    String   @map("framework_id")
  framework      ComplianceFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  controlId      String   @map("control_id") // CC6.1, 6.5.1
  category       String   // Access Control, Encryption
  name           String
  description    String
  guidance       String?
  testProcedures Json?    @map("test_procedures")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([frameworkId, controlId])
  @@index([frameworkId])
  @@map("compliance_controls")
}

// OWASP Top 10
model OwaspTop10 {
  id               String   @id // A01:2021
  year             Int      // 2021
  rank             Int      // 1-10
  name             String   // Broken Access Control
  description      String
  cweIds           String[] @map("cwe_ids") // Mapped CWEs
  preventionTips   Json     @default("[]") @map("prevention_tips")
  exampleScenarios Json     @default("[]") @map("example_scenarios")
  references       Json     @default("[]")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([year])
  @@map("owasp_top10")
}

// CIS Benchmarks
model CisBenchmark {
  id          String   @id @default(uuid())
  platform    String   // aws, azure, gcp, kubernetes, docker
  version     String   // 1.5.0
  controlId   String   @map("control_id") // 1.1.1
  level       Int      // 1 or 2
  title       String
  description String
  rationale   String?
  audit       String?
  remediation String?
  impact      String?
  references  Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([platform, version, controlId])
  @@index([platform])
  @@index([level])
  @@map("cis_benchmarks")
}

// NIST 800-53 Controls
model NistControl {
  id                    String   @id // AC-1, AU-2
  family                String   // Access Control, Audit
  name                  String
  description           String
  supplementalGuidance  String?  @map("supplemental_guidance")
  relatedControls       String[] @map("related_controls")
  baselineImpact        Json     @default("{}") @map("baseline_impact") // low, moderate, high mappings
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([family])
  @@map("nist_controls")
}

// MITRE ATT&CK Tactics
model AttackTactic {
  id           String   @id // TA0001
  name         String   // Initial Access
  description  String
  shortName    String   @map("short_name") // initial-access
  url          String   // MITRE URL
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  techniques   AttackTechnique[]

  @@map("attack_tactics")
}

// MITRE ATT&CK Techniques
model AttackTechnique {
  id              String   @id // T1566
  name            String   // Phishing
  description     String
  tacticId        String   @map("tactic_id")
  tactic          AttackTactic @relation(fields: [tacticId], references: [id], onDelete: Cascade)
  isSubTechnique  Boolean  @default(false) @map("is_sub_technique")
  parentId        String?  @map("parent_id") // For sub-techniques like T1566.001
  platforms       String[] // Windows, Linux, macOS, etc.
  dataSources     String[] @map("data_sources")
  detection       String?
  mitigations     Json     @default("[]")
  capecIds        String[] @map("capec_ids") // Mapped CAPEC patterns
  cweIds          String[] @map("cwe_ids") // Mapped CWEs
  url             String   // MITRE URL
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([tacticId])
  @@index([parentId])
  @@map("attack_techniques")
}

// MITRE ATT&CK Groups (Threat Actors)
model AttackGroup {
  id          String   @id // G0001
  groupId     String   @unique @map("group_id") // G0001
  name        String   // APT1
  description String?
  aliases     Json     @default("[]") // Alternative names
  techniques  String[] // Technique IDs used by group
  software    String[] @default([]) // Software/malware used
  url         String   // MITRE URL
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([name])
  @@map("attack_groups")
}

// MITRE CAPEC Attack Patterns
model CapecPattern {
  id              String   @id // CAPEC-66
  name            String   // SQL Injection
  description     String
  likelihood      String?  // High, Medium, Low
  severity        String?  // High, Medium, Low
  prerequisites   Json     @default("[]")
  skillsRequired  Json     @default("[]") @map("skills_required")
  resourcesRequired Json   @default("[]") @map("resources_required")
  consequences    Json     @default("[]")
  mitigations     Json     @default("[]")
  relatedCwes     String[] @map("related_cwes") // CWE-89, etc.
  relatedAttackPatterns String[] @map("related_attack_patterns")
  url             String
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("capec_patterns")
}

// Sync status tracking
model DataSyncStatus {
  id            String    @id // nvd, cwe, epss, kev, etc.
  lastSyncAt    DateTime? @map("last_sync_at")
  lastSuccessAt DateTime? @map("last_success_at")
  recordCount   Int       @default(0) @map("record_count")
  status        String    @default("pending") // pending, syncing, success, failed
  errorMessage  String?   @map("error_message")
  nextSyncAt    DateTime? @map("next_sync_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("data_sync_status")
}

// ============================================
// THREAT MODELING
// ============================================

// Threat Model project
model ThreatModel {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  name            String
  description     String?
  methodology     String   @default("stride") // stride, pasta, linddun, custom
  status          String   @default("draft") // draft, in_progress, completed, archived
  repositoryId    String?  @map("repository_id") // Optional link to repository
  version         Int      @default(1)
  createdBy       String   @map("created_by") // User ID
  lastModifiedBy  String?  @map("last_modified_by")
  completedAt     DateTime? @map("completed_at")
  archivedAt      DateTime? @map("archived_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  components      ThreatModelComponent[]
  dataFlows       ThreatModelDataFlow[]
  threats         Threat[]
  mitigations     ThreatMitigation[]

  @@index([tenantId])
  @@index([repositoryId])
  @@index([status])
  @@map("threat_models")
}

// System component in the threat model
model ThreatModelComponent {
  id              String   @id @default(uuid())
  threatModelId   String   @map("threat_model_id")
  name            String
  description     String?
  type            String   // process, datastore, external_entity, trust_boundary
  technology      String?  // e.g., "Node.js API", "PostgreSQL", "React SPA"
  criticality     String   @default("medium") // low, medium, high, critical
  dataClassification String? @map("data_classification") // public, internal, confidential, restricted
  // Position for diagram rendering
  positionX       Float    @default(0) @map("position_x")
  positionY       Float    @default(0) @map("position_y")
  // Additional metadata
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  threatModel     ThreatModel @relation(fields: [threatModelId], references: [id], onDelete: Cascade)
  outgoingFlows   ThreatModelDataFlow[] @relation("SourceComponent")
  incomingFlows   ThreatModelDataFlow[] @relation("TargetComponent")
  threats         ThreatComponentMapping[]

  @@index([threatModelId])
  @@map("threat_model_components")
}

// Data flow between components
model ThreatModelDataFlow {
  id              String   @id @default(uuid())
  threatModelId   String   @map("threat_model_id")
  sourceId        String   @map("source_id")
  targetId        String   @map("target_id")
  label           String?
  dataType        String?  @map("data_type") // e.g., "user_credentials", "pii", "api_response"
  protocol        String?  // e.g., "HTTPS", "gRPC", "SQL"
  authentication  Boolean  @default(false)
  encryption      Boolean  @default(false)
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  threatModel     ThreatModel @relation(fields: [threatModelId], references: [id], onDelete: Cascade)
  source          ThreatModelComponent @relation("SourceComponent", fields: [sourceId], references: [id], onDelete: Cascade)
  target          ThreatModelComponent @relation("TargetComponent", fields: [targetId], references: [id], onDelete: Cascade)
  threats         ThreatDataFlowMapping[]

  @@index([threatModelId])
  @@index([sourceId])
  @@index([targetId])
  @@map("threat_model_data_flows")
}

// Identified threat
model Threat {
  id              String   @id @default(uuid())
  threatModelId   String   @map("threat_model_id")
  title           String
  description     String
  category        String   // STRIDE: S, T, R, I, D, E / PASTA: Stage 1-7 / LINDDUN: L, I, N, D1, D2, U, N2
  attackVector    String?  @map("attack_vector")
  likelihood      String   @default("medium") // very_low, low, medium, high, very_high
  impact          String   @default("medium") // very_low, low, medium, high, very_high
  riskScore       Float?   @map("risk_score") // Calculated: likelihood * impact
  status          String   @default("identified") // identified, analyzed, mitigated, accepted, transferred
  priority        Int      @default(0)
  // Related standards
  strideCategory  String?  @map("stride_category") // spoofing, tampering, repudiation, information_disclosure, denial_of_service, elevation_of_privilege
  attackTechniqueIds String[] @map("attack_technique_ids") // MITRE ATT&CK technique IDs
  cweIds          String[] @map("cwe_ids") // Related CWE IDs
  capecIds        String[] @map("capec_ids") // Related CAPEC IDs
  // Tracking
  identifiedBy    String?  @map("identified_by")
  analyzedBy      String?  @map("analyzed_by")
  analyzedAt      DateTime? @map("analyzed_at")
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  threatModel     ThreatModel @relation(fields: [threatModelId], references: [id], onDelete: Cascade)
  components      ThreatComponentMapping[]
  dataFlows       ThreatDataFlowMapping[]
  mitigations     ThreatMitigationMapping[]

  @@index([threatModelId])
  @@index([category])
  @@index([status])
  @@index([riskScore])
  @@map("threats")
}

// Threat to component mapping
model ThreatComponentMapping {
  id              String   @id @default(uuid())
  threatId        String   @map("threat_id")
  componentId     String   @map("component_id")
  createdAt       DateTime @default(now()) @map("created_at")

  threat          Threat @relation(fields: [threatId], references: [id], onDelete: Cascade)
  component       ThreatModelComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([threatId, componentId])
  @@map("threat_component_mappings")
}

// Threat to data flow mapping
model ThreatDataFlowMapping {
  id              String   @id @default(uuid())
  threatId        String   @map("threat_id")
  dataFlowId      String   @map("data_flow_id")
  createdAt       DateTime @default(now()) @map("created_at")

  threat          Threat @relation(fields: [threatId], references: [id], onDelete: Cascade)
  dataFlow        ThreatModelDataFlow @relation(fields: [dataFlowId], references: [id], onDelete: Cascade)

  @@unique([threatId, dataFlowId])
  @@map("threat_data_flow_mappings")
}

// Mitigation / countermeasure
model ThreatMitigation {
  id              String   @id @default(uuid())
  threatModelId   String   @map("threat_model_id")
  title           String
  description     String
  type            String   // preventive, detective, corrective, compensating
  implementationStatus String @default("planned") @map("implementation_status") // planned, in_progress, implemented, verified
  priority        Int      @default(0)
  effort          String?  // low, medium, high
  cost            String?  // low, medium, high
  owner           String?  // Responsible person/team
  dueDate         DateTime? @map("due_date")
  implementedAt   DateTime? @map("implemented_at")
  verifiedAt      DateTime? @map("verified_at")
  // Links to other systems
  jiraIssueKey    String?  @map("jira_issue_key")
  findingIds      String[] @map("finding_ids") // Related finding IDs
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  threatModel     ThreatModel @relation(fields: [threatModelId], references: [id], onDelete: Cascade)
  threats         ThreatMitigationMapping[]

  @@index([threatModelId])
  @@index([implementationStatus])
  @@map("threat_mitigations")
}

// Threat to mitigation mapping
model ThreatMitigationMapping {
  id              String   @id @default(uuid())
  threatId        String   @map("threat_id")
  mitigationId    String   @map("mitigation_id")
  effectiveness   String   @default("partial") // none, partial, full
  createdAt       DateTime @default(now()) @map("created_at")

  threat          Threat @relation(fields: [threatId], references: [id], onDelete: Cascade)
  mitigation      ThreatMitigation @relation(fields: [mitigationId], references: [id], onDelete: Cascade)

  @@unique([threatId, mitigationId])
  @@map("threat_mitigation_mappings")
}

// ============================================
// SBOM & ENVIRONMENT TRACKING
// ============================================

// Software Bill of Materials document
model Sbom {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  repositoryId    String?  @map("repository_id")
  name            String
  version         String   @default("1.0.0")
  format          String   // spdx, cyclonedx
  formatVersion   String   @map("format_version") // SPDX-2.3, 1.5
  source          String   // upload, scan, ci_cd
  // Statistics
  componentCount  Int      @default(0) @map("component_count")
  vulnCount       Int      @default(0) @map("vuln_count")
  criticalCount   Int      @default(0) @map("critical_count")
  highCount       Int      @default(0) @map("high_count")
  mediumCount     Int      @default(0) @map("medium_count")
  lowCount        Int      @default(0) @map("low_count")
  // Metadata
  createdBy       String   @map("created_by")
  rawContent      String?  @map("raw_content") // Original SBOM content
  scanId          String?  @map("scan_id") // Link to scan if generated from scan
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  components      SbomComponent[]
  vulnerabilities SbomVulnerability[]

  @@index([tenantId])
  @@index([repositoryId])
  @@map("sboms")
}

// Component/package in SBOM
model SbomComponent {
  id              String   @id @default(uuid())
  sbomId          String   @map("sbom_id")
  purl            String?  // Package URL (pkg:npm/lodash@4.17.21)
  name            String
  version         String?
  type            String   // library, framework, application, container, os
  supplier        String?
  author          String?
  license         String?
  licenseSpdxId   String?  @map("license_spdx_id")
  description     String?
  checksum        String?  // SHA256 hash
  checksumAlgo    String?  @map("checksum_algo")
  homepage        String?
  downloadUrl     String?  @map("download_url")
  // Dependency info
  isDirect        Boolean  @default(true) @map("is_direct") // Direct or transitive
  parentId        String?  @map("parent_id") // Parent component for transitive
  depth           Int      @default(0) // Dependency depth
  scope           String?  // runtime, dev, test
  // Metadata
  externalRefs    Json     @default("[]") @map("external_refs")
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  sbom            Sbom @relation(fields: [sbomId], references: [id], onDelete: Cascade)
  vulnerabilities SbomComponentVuln[]

  @@index([sbomId])
  @@index([purl])
  @@index([name])
  @@map("sbom_components")
}

// Vulnerability affecting SBOM components
model SbomVulnerability {
  id              String   @id @default(uuid())
  sbomId          String   @map("sbom_id")
  cveId           String?  @map("cve_id") // CVE-2024-12345
  ghsaId          String?  @map("ghsa_id") // GHSA-xxxx
  osvId           String?  @map("osv_id") // OSV ID
  severity        String   // critical, high, medium, low
  cvssScore       Float?   @map("cvss_score")
  cvssVector      String?  @map("cvss_vector")
  title           String
  description     String?
  recommendation  String?
  fixedVersion    String?  @map("fixed_version")
  // Enrichment
  epssScore       Float?   @map("epss_score")
  isKev           Boolean  @default(false) @map("is_kev")
  publishedAt     DateTime? @map("published_at")
  references      Json     @default("[]")
  // Status tracking
  status          String   @default("open") // open, patched, ignored, accepted
  ignoredReason   String?  @map("ignored_reason")
  ignoredBy       String?  @map("ignored_by")
  ignoredAt       DateTime? @map("ignored_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  sbom            Sbom @relation(fields: [sbomId], references: [id], onDelete: Cascade)
  components      SbomComponentVuln[]

  @@index([sbomId])
  @@index([cveId])
  @@index([severity])
  @@index([status])
  @@map("sbom_vulnerabilities")
}

// Junction table for component-vulnerability mapping
model SbomComponentVuln {
  id              String   @id @default(uuid())
  componentId     String   @map("component_id")
  vulnId          String   @map("vuln_id")
  createdAt       DateTime @default(now()) @map("created_at")

  component       SbomComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)
  vulnerability   SbomVulnerability @relation(fields: [vulnId], references: [id], onDelete: Cascade)

  @@unique([componentId, vulnId])
  @@map("sbom_component_vulns")
}

// Container Registry connection
model ContainerRegistry {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  name            String
  type            String   // docker_hub, ecr, gcr, acr, ghcr, harbor
  url             String   // Registry URL
  username        String?
  password        String?  // Encrypted
  accessToken     String?  @map("access_token") // Encrypted, for token-based auth
  awsRegion       String?  @map("aws_region") // For ECR
  awsAccessKeyId  String?  @map("aws_access_key_id")
  awsSecretKey    String?  @map("aws_secret_key") // Encrypted
  isActive        Boolean  @default(true) @map("is_active")
  lastSyncAt      DateTime? @map("last_sync_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  images          ContainerImage[]

  @@index([tenantId])
  @@map("container_registries")
}

// Container image for scanning
model ContainerImage {
  id              String   @id @default(uuid())
  registryId      String   @map("registry_id")
  tenantId        String   @map("tenant_id")
  repository      String   // e.g., myapp/api
  tag             String   // e.g., latest, v1.2.3
  digest          String?  // SHA256 digest
  size            BigInt?  // Image size in bytes
  platform        String?  // linux/amd64, linux/arm64
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  registry        ContainerRegistry @relation(fields: [registryId], references: [id], onDelete: Cascade)
  scans           ContainerScan[]

  @@unique([registryId, repository, tag])
  @@index([tenantId])
  @@index([registryId])
  @@map("container_images")
}

// Container scan result
model ContainerScan {
  id              String   @id @default(uuid())
  imageId         String   @map("image_id")
  tenantId        String   @map("tenant_id")
  status          String   @default("pending") // pending, scanning, completed, failed
  scanner         String   // trivy, grype, etc.
  // Statistics
  vulnCount       Int      @default(0) @map("vuln_count")
  criticalCount   Int      @default(0) @map("critical_count")
  highCount       Int      @default(0) @map("high_count")
  mediumCount     Int      @default(0) @map("medium_count")
  lowCount        Int      @default(0) @map("low_count")
  // Layers
  layerCount      Int      @default(0) @map("layer_count")
  // Timing
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  duration        Int?     // seconds
  errorMessage    String?  @map("error_message")
  // Raw output
  rawOutput       Json?    @map("raw_output")
  sbomId          String?  @map("sbom_id") // Generated SBOM
  createdAt       DateTime @default(now()) @map("created_at")

  image           ContainerImage @relation(fields: [imageId], references: [id], onDelete: Cascade)
  findings        ContainerFinding[]

  @@index([imageId])
  @@index([tenantId])
  @@index([status])
  @@map("container_scans")
}

// Vulnerability found in container scan
model ContainerFinding {
  id              String   @id @default(uuid())
  scanId          String   @map("scan_id")
  cveId           String?  @map("cve_id")
  severity        String   // critical, high, medium, low
  title           String
  description     String?
  pkgName         String   @map("pkg_name")
  installedVersion String  @map("installed_version")
  fixedVersion    String?  @map("fixed_version")
  layer           String?  // Layer where package was installed
  // Enrichment
  cvssScore       Float?   @map("cvss_score")
  epssScore       Float?   @map("epss_score")
  isKev           Boolean  @default(false) @map("is_kev")
  // Status
  status          String   @default("open") // open, fixed, ignored
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  scan            ContainerScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([scanId])
  @@index([cveId])
  @@index([severity])
  @@map("container_findings")
}

// Deployment environment
model Environment {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  name            String   // development, staging, production
  type            String   // kubernetes, ecs, cloud_run, lambda, vm
  description     String?
  // Kubernetes config
  kubeConfig      String?  @map("kube_config") // Encrypted
  kubeContext     String?  @map("kube_context")
  namespace       String?
  // Cloud config
  cloudProvider   String?  @map("cloud_provider") // aws, gcp, azure
  cloudRegion     String?  @map("cloud_region")
  cloudProject    String?  @map("cloud_project")
  // Status
  isActive        Boolean  @default(true) @map("is_active")
  lastSyncAt      DateTime? @map("last_sync_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  deployments     Deployment[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("environments")
}

// Deployed service/application
model Deployment {
  id              String   @id @default(uuid())
  environmentId   String   @map("environment_id")
  tenantId        String   @map("tenant_id")
  repositoryId    String?  @map("repository_id")
  name            String   // Service name
  version         String?  // Deployed version
  image           String?  // Container image
  imageDigest     String?  @map("image_digest")
  replicas        Int      @default(1)
  status          String   @default("unknown") // healthy, degraded, unhealthy, unknown
  // Security posture
  vulnCount       Int      @default(0) @map("vuln_count")
  criticalCount   Int      @default(0) @map("critical_count")
  lastScanId      String?  @map("last_scan_id")
  lastSbomId      String?  @map("last_sbom_id")
  // Metadata
  labels          Json     @default("{}")
  annotations     Json     @default("{}")
  exposedPorts    Int[]    @default([]) @map("exposed_ports")
  hasIngress      Boolean  @default(false) @map("has_ingress")
  ingressHosts    String[] @default([]) @map("ingress_hosts")
  // Tracking
  deployedAt      DateTime? @map("deployed_at")
  deployedBy      String?  @map("deployed_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  environment     Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@unique([environmentId, name])
  @@index([tenantId])
  @@index([environmentId])
  @@index([repositoryId])
  @@map("deployments")
}
