generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                      String              @id @default(uuid())
  name                    String
  slug                    String              @unique
  plan                    String              @default("free")
  createdAt               DateTime            @default(now()) @map("created_at")
  updatedAt               DateTime            @updatedAt @map("updated_at")
  aiTriageEnabled         Boolean             @default(false) @map("ai_triage_enabled")
  auditRetentionDays      Int                 @default(90) @map("audit_retention_days")
  findingRetentionDays    Int                 @default(365) @map("finding_retention_days")
  isActive                Boolean             @default(true) @map("is_active")
  maxRepositories         Int                 @default(10) @map("max_repositories")
  maxUsers                Int                 @default(5) @map("max_users")
  scanRetentionDays       Int                 @default(90) @map("scan_retention_days")
  allowProjectConnections Boolean             @default(false) @map("allow_project_connections")
  apiKeys                 ApiKey[]
  findingBaselines        FindingBaseline[]
  findings                Finding[]
  jiraConfig              JiraConfig?
  notificationConfig      NotificationConfig?
  orgMembers              OrgMember[]
  projects                Project[]
  repositories            Repository[]
  scanConfigs             ScanConfig[]
  scans                   Scan[]
  scmConnections          ScmConnection[]
  users                   User[]

  @@map("tenants")
}

model Project {
  id                String                    @id @default(cuid())
  tenantId          String                    @map("tenant_id")
  name              String
  description       String?
  status            ProjectStatus             @default(ACTIVE)
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")
  environments      Environment[]
  findings          Finding[]
  pipelineGates     PipelineGate[]
  complianceConfigs ProjectComplianceConfig[]
  members           ProjectMember[]
  tenant            Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  repositories      Repository[]
  sboms             Sbom[]
  scans             Scan[]
  threatModels      ThreatModel[]
  scmAccess         ProjectScmAccess[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("projects")
}

model User {
  id                 String          @id @default(uuid())
  tenantId           String          @map("tenant_id")
  email              String
  passwordHash       String?         @map("password_hash")
  role               String          @default("member")
  createdAt          DateTime        @default(now()) @map("created_at")
  inviteToken        String?         @unique @map("invite_token")
  invitedAt          DateTime?       @map("invited_at")
  invitedBy          String?         @map("invited_by")
  lastLoginAt        DateTime?       @map("last_login_at")
  name               String?
  status             String          @default("active")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  apiKeys            ApiKey[]
  orgMemberships     OrgMember[]
  projectMemberships ProjectMember[]
  tenant             Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@map("users")
}

model OrgMember {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tenantId  String   @map("tenant_id")
  role      String   @default("member")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
  @@map("org_members")
}

model ProjectMember {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  projectId String   @map("project_id")
  role      String   @default("developer")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

model ScmConnection {
  id             String             @id @default(uuid())
  tenantId       String             @map("tenant_id")
  provider       String
  authMethod     String             @map("auth_method")
  accessToken    String             @map("access_token")
  refreshToken   String?            @map("refresh_token")
  tokenExpiresAt DateTime?          @map("token_expires_at")
  installationId String?            @map("installation_id")
  externalId     String             @map("external_id")
  externalName   String             @map("external_name")
  scope          String[]
  isActive       Boolean            @default(true) @map("is_active")
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  repositories   Repository[]
  tenant         Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectAccess  ProjectScmAccess[]

  @@unique([tenantId, provider, externalId])
  @@index([tenantId])
  @@map("scm_connections")
}

// Project-level access to SCM connections
model ProjectScmAccess {
  id           String              @id @default(uuid())
  projectId    String              @map("project_id")
  connectionId String              @map("connection_id")
  createdAt    DateTime            @default(now()) @map("created_at")
  project      Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  connection   ScmConnection       @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  repoAccess   ProjectRepoAccess[]

  @@unique([projectId, connectionId])
  @@index([projectId])
  @@index([connectionId])
  @@map("project_scm_access")
}

// Project-level access to specific repositories from a connection
model ProjectRepoAccess {
  id              String           @id @default(uuid())
  projectAccessId String           @map("project_access_id")
  externalRepoId  String           @map("external_repo_id")
  fullName        String           @map("full_name")
  createdAt       DateTime         @default(now()) @map("created_at")
  projectAccess   ProjectScmAccess @relation(fields: [projectAccessId], references: [id], onDelete: Cascade)

  @@unique([projectAccessId, externalRepoId])
  @@index([projectAccessId])
  @@map("project_repo_access")
}

model Repository {
  id                      String            @id @default(uuid())
  tenantId                String            @map("tenant_id")
  connectionId            String            @map("connection_id")
  name                    String
  fullName                String            @map("full_name")
  cloneUrl                String            @map("clone_url")
  htmlUrl                 String            @map("html_url")
  defaultBranch           String            @default("main") @map("default_branch")
  language                String?
  isPrivate               Boolean           @default(true) @map("is_private")
  isActive                Boolean           @default(true) @map("is_active")
  lastScanAt              DateTime?         @map("last_scan_at")
  createdAt               DateTime          @default(now()) @map("created_at")
  updatedAt               DateTime          @updatedAt @map("updated_at")
  projectId               String?           @map("project_id")
  // Webhook configuration
  webhookUrl              String?           @unique @map("webhook_url")
  webhookSecret           String?           @map("webhook_secret")
  webhookBranchFilters    String[]          @default([]) @map("webhook_branch_filters")
  webhookBranchExcludes   String[]          @default([]) @map("webhook_branch_excludes")
  webhookScannersEnabled  String[]          @default([]) @map("webhook_scanners_enabled")
  webhookBlockSeverity    String?           @map("webhook_block_severity")
  webhookDiffOnly         Boolean           @default(true) @map("webhook_diff_only")
  webhookInlineComments   Boolean           @default(true) @map("webhook_inline_comments")
  findingBaselines        FindingBaseline[]
  connection              ScmConnection     @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  project                 Project?          @relation(fields: [projectId], references: [id])
  tenant                  Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  scanConfig              ScanConfig?
  scans                   Scan[]

  @@unique([tenantId, fullName])
  @@index([tenantId])
  @@index([connectionId])
  @@map("repositories")
}

model ScanConfig {
  id                   String     @id @default(uuid())
  tenantId             String     @map("tenant_id")
  repositoryId         String     @unique @map("repository_id")
  enableSast           Boolean    @default(true) @map("enable_sast")
  enableSca            Boolean    @default(true) @map("enable_sca")
  enableSecrets        Boolean    @default(true) @map("enable_secrets")
  enableIac            Boolean    @default(true) @map("enable_iac")
  enableDast           Boolean    @default(false) @map("enable_dast")
  enableContainerScan  Boolean    @default(false) @map("enable_container_scan")
  dastScanMode         String     @default("standard") @map("dast_scan_mode") // quick, standard, full
  targetUrls           String[]   @default([]) @map("target_urls")
  containerImages      String[]   @default([]) @map("container_images")
  branches             String[]   @default(["main", "master"])
  autoScanOnPush       Boolean    @default(true) @map("auto_scan_on_push")
  autoScanOnPR         Boolean    @default(true) @map("auto_scan_on_pr")
  skipPaths            String[]   @default(["node_modules", "vendor", ".git"]) @map("skip_paths")
  customRules          Json?      @map("custom_rules")
  scheduleEnabled      Boolean    @default(false) @map("schedule_enabled")
  scheduleCron         String?    @map("schedule_cron")
  scheduleTimezone     String     @default("UTC") @map("schedule_timezone")
  lastScheduledScan    DateTime?  @map("last_scheduled_scan")
  nextScheduledScan    DateTime?  @map("next_scheduled_scan")
  prCommentsEnabled    Boolean    @default(true) @map("pr_comments_enabled")
  prCommentMaxFindings Int        @default(20) @map("pr_comment_max_findings")
  prCommentSeverities  String[]   @default(["critical", "high", "medium"]) @map("pr_comment_severities")
  prDiffOnly           Boolean    @default(true) @map("pr_diff_only")
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")
  repository           Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  tenant               Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("scan_configs")
}

model Scan {
  id             String          @id @default(uuid())
  tenantId       String          @map("tenant_id")
  repositoryId   String          @map("repository_id")
  commitSha      String          @map("commit_sha")
  branch         String
  status         String          @default("pending")
  triggeredBy    String          @map("triggered_by")
  triggerEvent   String?         @map("trigger_event")
  pullRequestId  String?         @map("pull_request_id")
  pullRequestUrl String?         @map("pull_request_url")
  checkRunId     String?         @map("check_run_id")
  sarifUploadId  String?         @map("sarif_upload_id")
  sarifUploadUrl String?         @map("sarif_upload_url")
  startedAt      DateTime?       @map("started_at")
  completedAt    DateTime?       @map("completed_at")
  duration       Int?
  errorMessage   String?         @map("error_message")
  createdAt      DateTime        @default(now()) @map("created_at")
  projectId      String?         @map("project_id")
  findings       Finding[]
  scannerResults ScannerResult[]
  project        Project?        @relation(fields: [projectId], references: [id])
  repository     Repository      @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([repositoryId])
  @@index([projectId])
  @@index([status])
  @@map("scans")
}

model ScannerResult {
  id            String    @id @default(uuid())
  scanId        String    @map("scan_id")
  scanner       String // e.g., "semgrep", "trivy", "gitleaks", "nuclei"
  category      String // e.g., "sast", "sca", "secrets", "iac", "dast"
  status        String // "pending", "running", "completed", "failed", "skipped"
  exitCode      Int?      @map("exit_code")
  duration      Int? // milliseconds
  findingsCount Int       @default(0) @map("findings_count")
  errorMessage  String?   @map("error_message")
  command       String? // The command that was run
  targetInfo    String?   @map("target_info") // e.g., target URLs for DAST, languages for SAST
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  scan          Scan      @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([scanId])
  @@index([scanner])
  @@map("scanner_results")
}

model Finding {
  id                 String    @id @default(uuid())
  tenantId           String    @map("tenant_id")
  scanId             String    @map("scan_id")
  repositoryId       String    @map("repository_id")
  scanner            String
  ruleId             String    @map("rule_id")
  severity           String
  title              String
  description        String?
  filePath           String    @map("file_path")
  startLine          Int?      @map("start_line")
  endLine            Int?      @map("end_line")
  snippet            String?
  cweId              String?   @map("cwe_id")
  cveId              String?   @map("cve_id")
  owasp              String?
  confidence         String?
  autoFix            String?   @map("auto_fix")
  remediation        String?
  status             String    @default("open")
  dismissReason      String?   @map("dismiss_reason")
  dismissedAt        DateTime? @map("dismissed_at")
  prCommentId        String?   @map("pr_comment_id")
  triagedBy          String?   @map("triaged_by")
  triagedAt          DateTime? @map("triaged_at")
  fixedInCommit      String?   @map("fixed_in_commit")
  fingerprint        String?
  jiraIssueKey       String?   @map("jira_issue_key")
  jiraIssueUrl       String?   @map("jira_issue_url")
  aiAnalysis         String?   @map("ai_analysis")
  aiConfidence       Float?    @map("ai_confidence")
  aiSeverity         String?   @map("ai_severity")
  aiFalsePositive    Boolean?  @map("ai_false_positive")
  aiExploitability   String?   @map("ai_exploitability")
  aiRemediation      String?   @map("ai_remediation")
  aiTriagedAt        DateTime? @map("ai_triaged_at")
  firstSeenAt        DateTime  @default(now()) @map("first_seen_at")
  cveData            Json?     @map("cve_data")
  cweData            Json?     @map("cwe_data")
  owaspCategory      String?   @map("owasp_category")
  complianceControls Json?     @map("compliance_controls")
  attackTechniques   Json?     @map("attack_techniques")
  capecPatterns      Json?     @map("capec_patterns")
  riskScore          Float?    @map("risk_score")
  isKev              Boolean   @default(false) @map("is_kev")
  epssScore          Float?    @map("epss_score")
  enrichedAt         DateTime? @map("enriched_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  projectId          String?   @map("project_id")
  project            Project?  @relation(fields: [projectId], references: [id])
  scan               Scan      @relation(fields: [scanId], references: [id], onDelete: Cascade)
  tenant             Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([scanId])
  @@index([repositoryId])
  @@index([projectId])
  @@index([severity])
  @@index([status])
  @@index([fingerprint])
  @@map("findings")
}

model WebhookEvent {
  id          String    @id @default(uuid())
  tenantId    String?   @map("tenant_id")
  provider    String
  eventType   String    @map("event_type")
  deliveryId  String?   @map("delivery_id")
  signature   String
  payload     Json
  processed   Boolean   @default(false)
  processedAt DateTime? @map("processed_at")
  error       String?
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([provider, deliveryId])
  @@index([processed])
  @@map("webhook_events")
}

model NotificationConfig {
  id                   String   @id @default(uuid())
  tenantId             String   @unique @map("tenant_id")
  slackWebhookUrl      String?  @map("slack_webhook_url")
  slackChannel         String?  @map("slack_channel")
  slackEnabled         Boolean  @default(false) @map("slack_enabled")
  emailEnabled         Boolean  @default(false) @map("email_enabled")
  emailRecipients      String[] @default([]) @map("email_recipients")
  notifyOnScanStart    Boolean  @default(false) @map("notify_on_scan_start")
  notifyOnScanComplete Boolean  @default(true) @map("notify_on_scan_complete")
  notifyOnCritical     Boolean  @default(true) @map("notify_on_critical")
  notifyOnHigh         Boolean  @default(false) @map("notify_on_high")
  weeklyDigestEnabled  Boolean  @default(false) @map("weekly_digest_enabled")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  tenant               Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("notification_configs")
}

model PlatformConfig {
  id                     String   @id @default(uuid())
  aiProvider             String   @default("anthropic") @map("ai_provider")
  aiModel                String   @default("claude-sonnet-4-20250514") @map("ai_model")
  aiApiKey               String?  @map("ai_api_key")
  defaultPlan            String   @default("free") @map("default_plan")
  defaultMaxUsers        Int      @default(5) @map("default_max_users")
  defaultMaxRepositories Int      @default(10) @map("default_max_repositories")
  maintenanceMode        Boolean  @default(false) @map("maintenance_mode")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@map("platform_config")
}

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String?  @map("tenant_id")
  userId     String?  @map("user_id")
  userEmail  String?  @map("user_email")
  action     String
  resource   String
  resourceId String?  @map("resource_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

model PlatformAdmin {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  isSuperAdmin Boolean   @default(false) @map("is_super_admin")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("platform_admins")
}

model JiraConfig {
  id                   String   @id @default(uuid())
  tenantId             String   @unique @map("tenant_id")
  jiraUrl              String   @map("jira_url")
  email                String
  apiToken             String   @map("api_token")
  projectKey           String   @map("project_key")
  issueType            String   @default("Bug") @map("issue_type")
  enabled              Boolean  @default(false)
  autoCreate           Boolean  @default(false) @map("auto_create")
  autoCreateSeverities String[] @default(["critical", "high"]) @map("auto_create_severities")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  tenant               Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("jira_configs")
}

model FindingBaseline {
  id           String     @id @default(uuid())
  tenantId     String     @map("tenant_id")
  repositoryId String     @map("repository_id")
  fingerprint  String
  reason       String
  baselinedBy  String     @map("baselined_by")
  expiresAt    DateTime?  @map("expires_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, repositoryId, fingerprint])
  @@index([tenantId])
  @@index([repositoryId])
  @@map("finding_baselines")
}

model ApiKey {
  id         String    @id @default(uuid())
  tenantId   String    @map("tenant_id")
  userId     String    @map("user_id")
  name       String
  keyHash    String    @map("key_hash")
  keyPrefix  String    @map("key_prefix")
  scopes     String[]
  expiresAt  DateTime? @map("expires_at")
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([tenantId])
  @@index([userId])
  @@map("api_keys")
}

model CloudAccount {
  id          String        @id @default(uuid())
  tenantId    String        @map("tenant_id")
  provider    String
  name        String
  accountId   String        @map("account_id")
  credentials Json
  regions     String[]      @default([])
  enabled     Boolean       @default(true)
  lastScanAt  DateTime?     @map("last_scan_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  findings    CspmFinding[]

  @@unique([tenantId, provider, accountId])
  @@index([tenantId])
  @@map("cloud_accounts")
}

model CspmFinding {
  id           String       @id @default(uuid())
  accountId    String       @map("account_id")
  provider     String
  service      String
  region       String
  resourceId   String       @map("resource_id")
  resourceType String       @map("resource_type")
  severity     String
  title        String
  description  String
  remediation  String?
  compliance   String[]     @default([])
  status       String       @default("open")
  firstSeenAt  DateTime     @default(now()) @map("first_seen_at")
  lastSeenAt   DateTime     @default(now()) @map("last_seen_at")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  account      CloudAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([severity])
  @@index([status])
  @@index([service])
  @@map("cspm_findings")
}

model AlertRule {
  id                String         @id @default(uuid())
  tenantId          String         @map("tenant_id")
  name              String
  description       String?
  enabled           Boolean        @default(true)
  eventTypes        String[]       @default([]) @map("event_types")
  sources           String[]       @default([])
  severities        String[]       @default([])
  titlePattern      String?        @map("title_pattern")
  threshold         Int            @default(1)
  timeWindowMinutes Int            @default(5) @map("time_window_minutes")
  notifySlack       Boolean        @default(false) @map("notify_slack")
  notifyEmail       Boolean        @default(true) @map("notify_email")
  createJiraIssue   Boolean        @default(false) @map("create_jira_issue")
  lastTriggeredAt   DateTime?      @map("last_triggered_at")
  triggerCount      Int            @default(0) @map("trigger_count")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  history           AlertHistory[]

  @@index([tenantId])
  @@index([enabled])
  @@map("alert_rules")
}

model AlertHistory {
  id            String    @id @default(uuid())
  ruleId        String    @map("rule_id")
  tenantId      String    @map("tenant_id")
  matchedEvents Int       @map("matched_events")
  sampleEvents  Json      @map("sample_events")
  triggeredAt   DateTime  @map("triggered_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  rule          AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([ruleId])
  @@index([triggeredAt])
  @@map("alert_history")
}

model PipelineGate {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  repositoryId    String?  @map("repository_id")
  stage           String
  enabled         Boolean  @default(true)
  blockSeverity   String   @default("critical") @map("block_severity")
  notifyOnFailure Boolean  @default(true) @map("notify_on_failure")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  projectId       String?  @map("project_id")
  project         Project? @relation(fields: [projectId], references: [id])

  @@unique([tenantId, repositoryId, stage])
  @@index([tenantId])
  @@index([repositoryId])
  @@index([projectId])
  @@map("pipeline_gates")
}

model DiffCache {
  id            String   @id @default(uuid())
  scanId        String   @unique @map("scan_id")
  pullRequestId String   @map("pull_request_id")
  diffData      Json     @map("diff_data")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([scanId])
  @@map("diff_cache")
}

model Cve {
  id               String    @id
  description      String
  publishedDate    DateTime  @map("published_date")
  lastModifiedDate DateTime  @map("last_modified_date")
  cvssV3Score      Float?    @map("cvss_v3_score")
  cvssV3Vector     String?   @map("cvss_v3_vector")
  cvssV3Severity   String?   @map("cvss_v3_severity")
  cvssV2Score      Float?    @map("cvss_v2_score")
  cweIds           String[]  @map("cwe_ids")
  references       Json      @default("[]")
  affectedProducts Json      @default("[]") @map("affected_products")
  epssScore        Float?    @map("epss_score")
  epssPercentile   Float?    @map("epss_percentile")
  isKev            Boolean   @default(false) @map("is_kev")
  kevDateAdded     DateTime? @map("kev_date_added")
  kevDueDate       DateTime? @map("kev_due_date")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@index([cvssV3Severity])
  @@index([publishedDate])
  @@index([isKev])
  @@index([epssScore])
  @@map("cves")
}

model Cwe {
  id                   String                 @id
  name                 String
  description          String
  extendedDescription  String?                @map("extended_description")
  relatedWeaknesses    String[]               @map("related_weaknesses")
  commonConsequences   Json                   @default("[]") @map("common_consequences")
  potentialMitigations Json                   @default("[]") @map("potential_mitigations")
  detectionMethods     Json                   @default("[]") @map("detection_methods")
  applicablePlatforms  Json                   @default("[]") @map("applicable_platforms")
  likelihoodOfExploit  String?                @map("likelihood_of_exploit")
  createdAt            DateTime               @default(now()) @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")
  complianceMappings   CweComplianceMapping[]

  @@map("cwes")
}

model CweComplianceMapping {
  id                 String  @id @default(uuid())
  cweId              String  @map("cwe_id")
  frameworkId        String  @map("framework_id")
  controlId          String  @map("control_id")
  controlName        String  @map("control_name")
  controlDescription String? @map("control_description")
  cwe                Cwe     @relation(fields: [cweId], references: [id], onDelete: Cascade)

  @@unique([cweId, frameworkId, controlId])
  @@index([frameworkId])
  @@index([cweId])
  @@map("cwe_compliance_mappings")
}

model ComplianceFramework {
  id          String              @id
  name        String
  version     String
  description String
  sourceUrl   String              @map("source_url")
  lastUpdated DateTime            @map("last_updated")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  controls    ComplianceControl[]

  @@map("compliance_frameworks")
}

model ComplianceControl {
  id             String              @id @default(uuid())
  frameworkId    String              @map("framework_id")
  controlId      String              @map("control_id")
  category       String
  name           String
  description    String
  guidance       String?
  testProcedures Json?               @map("test_procedures")
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  framework      ComplianceFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)

  @@unique([frameworkId, controlId])
  @@index([frameworkId])
  @@map("compliance_controls")
}

model OwaspTop10 {
  id               String   @id
  year             Int
  rank             Int
  name             String
  description      String
  cweIds           String[] @map("cwe_ids")
  preventionTips   Json     @default("[]") @map("prevention_tips")
  exampleScenarios Json     @default("[]") @map("example_scenarios")
  references       Json     @default("[]")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([year])
  @@map("owasp_top10")
}

model CisBenchmark {
  id          String   @id @default(uuid())
  platform    String
  version     String
  controlId   String   @map("control_id")
  level       Int
  title       String
  description String
  rationale   String?
  audit       String?
  remediation String?
  impact      String?
  references  Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([platform, version, controlId])
  @@index([platform])
  @@index([level])
  @@map("cis_benchmarks")
}

model NistControl {
  id                   String   @id
  family               String
  name                 String
  description          String
  supplementalGuidance String?  @map("supplemental_guidance")
  relatedControls      String[] @map("related_controls")
  baselineImpact       Json     @default("{}") @map("baseline_impact")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@index([family])
  @@map("nist_controls")
}

model AttackTactic {
  id          String            @id
  name        String
  description String
  shortName   String            @map("short_name")
  url         String
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  techniques  AttackTechnique[]

  @@map("attack_tactics")
}

model AttackTechnique {
  id             String       @id
  name           String
  description    String
  tacticId       String       @map("tactic_id")
  isSubTechnique Boolean      @default(false) @map("is_sub_technique")
  parentId       String?      @map("parent_id")
  platforms      String[]
  dataSources    String[]     @map("data_sources")
  detection      String?
  mitigations    Json         @default("[]")
  capecIds       String[]     @map("capec_ids")
  cweIds         String[]     @map("cwe_ids")
  url            String
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  tactic         AttackTactic @relation(fields: [tacticId], references: [id], onDelete: Cascade)

  @@index([tacticId])
  @@index([parentId])
  @@map("attack_techniques")
}

model AttackGroup {
  id          String   @id
  groupId     String   @unique @map("group_id")
  name        String
  description String?
  aliases     Json     @default("[]")
  techniques  String[]
  software    String[] @default([])
  url         String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([name])
  @@map("attack_groups")
}

model CapecPattern {
  id                    String   @id
  name                  String
  description           String
  likelihood            String?
  severity              String?
  prerequisites         Json     @default("[]")
  skillsRequired        Json     @default("[]") @map("skills_required")
  resourcesRequired     Json     @default("[]") @map("resources_required")
  consequences          Json     @default("[]")
  mitigations           Json     @default("[]")
  relatedCwes           String[] @map("related_cwes")
  relatedAttackPatterns String[] @map("related_attack_patterns")
  url                   String
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("capec_patterns")
}

model DataSyncStatus {
  id            String    @id
  lastSyncAt    DateTime? @map("last_sync_at")
  lastSuccessAt DateTime? @map("last_success_at")
  recordCount   Int       @default(0) @map("record_count")
  status        String    @default("pending")
  errorMessage  String?   @map("error_message")
  nextSyncAt    DateTime? @map("next_sync_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("data_sync_status")
}

model ThreatModel {
  id             String                 @id @default(uuid())
  tenantId       String                 @map("tenant_id")
  name           String
  description    String?
  methodology    String                 @default("stride")
  status         String                 @default("draft")
  repositoryId   String?                @map("repository_id")
  version        Int                    @default(1)
  createdBy      String                 @map("created_by")
  lastModifiedBy String?                @map("last_modified_by")
  completedAt    DateTime?              @map("completed_at")
  archivedAt     DateTime?              @map("archived_at")
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")
  projectId      String?                @map("project_id")
  mitigations    ThreatMitigation[]
  components     ThreatModelComponent[]
  dataFlows      ThreatModelDataFlow[]
  project        Project?               @relation(fields: [projectId], references: [id])
  threats        Threat[]

  @@index([tenantId])
  @@index([projectId])
  @@index([repositoryId])
  @@index([status])
  @@map("threat_models")
}

model ThreatModelComponent {
  id                 String                   @id @default(uuid())
  threatModelId      String                   @map("threat_model_id")
  name               String
  description        String?
  type               String
  technology         String?
  criticality        String                   @default("medium")
  dataClassification String?                  @map("data_classification")
  positionX          Float                    @default(0) @map("position_x")
  positionY          Float                    @default(0) @map("position_y")
  metadata           Json                     @default("{}")
  createdAt          DateTime                 @default(now()) @map("created_at")
  updatedAt          DateTime                 @updatedAt @map("updated_at")
  threats            ThreatComponentMapping[]
  threatModel        ThreatModel              @relation(fields: [threatModelId], references: [id], onDelete: Cascade)
  outgoingFlows      ThreatModelDataFlow[]    @relation("SourceComponent")
  incomingFlows      ThreatModelDataFlow[]    @relation("TargetComponent")

  @@index([threatModelId])
  @@map("threat_model_components")
}

model ThreatModelDataFlow {
  id             String                  @id @default(uuid())
  threatModelId  String                  @map("threat_model_id")
  sourceId       String                  @map("source_id")
  targetId       String                  @map("target_id")
  label          String?
  dataType       String?                 @map("data_type")
  protocol       String?
  authentication Boolean                 @default(false)
  encryption     Boolean                 @default(false)
  metadata       Json                    @default("{}")
  createdAt      DateTime                @default(now()) @map("created_at")
  updatedAt      DateTime                @updatedAt @map("updated_at")
  threats        ThreatDataFlowMapping[]
  source         ThreatModelComponent    @relation("SourceComponent", fields: [sourceId], references: [id], onDelete: Cascade)
  target         ThreatModelComponent    @relation("TargetComponent", fields: [targetId], references: [id], onDelete: Cascade)
  threatModel    ThreatModel             @relation(fields: [threatModelId], references: [id], onDelete: Cascade)

  @@index([threatModelId])
  @@index([sourceId])
  @@index([targetId])
  @@map("threat_model_data_flows")
}

model Threat {
  id                 String                    @id @default(uuid())
  threatModelId      String                    @map("threat_model_id")
  title              String
  description        String
  category           String
  attackVector       String?                   @map("attack_vector")
  likelihood         String                    @default("medium")
  impact             String                    @default("medium")
  riskScore          Float?                    @map("risk_score")
  status             String                    @default("identified")
  priority           Int                       @default(0)
  strideCategory     String?                   @map("stride_category")
  attackTechniqueIds String[]                  @map("attack_technique_ids")
  cweIds             String[]                  @map("cwe_ids")
  capecIds           String[]                  @map("capec_ids")
  identifiedBy       String?                   @map("identified_by")
  analyzedBy         String?                   @map("analyzed_by")
  analyzedAt         DateTime?                 @map("analyzed_at")
  metadata           Json                      @default("{}")
  createdAt          DateTime                  @default(now()) @map("created_at")
  updatedAt          DateTime                  @updatedAt @map("updated_at")
  commentedBy        String?                   @map("commented_by")
  comments           String?
  complexity         String?
  diagramId          String?                   @map("diagram_id")
  existingControls   String?                   @map("existing_controls")
  finalRisk          String?                   @map("final_risk")
  gapRecommendation  String?                   @map("gap_recommendation")
  impactCIA          String?                   @map("impact_cia")
  jiraCard           String?                   @map("jira_card")
  likelihoodPre      String?                   @map("likelihood_pre")
  riskAfterExisting  String?                   @map("risk_after_existing")
  skillsRequired     String?                   @map("skills_required")
  threatActor        String?                   @map("threat_actor")
  vulnerability      String?
  components         ThreatComponentMapping[]
  dataFlows          ThreatDataFlowMapping[]
  mitigations        ThreatMitigationMapping[]
  threatModel        ThreatModel               @relation(fields: [threatModelId], references: [id], onDelete: Cascade)

  @@index([threatModelId])
  @@index([category])
  @@index([status])
  @@index([riskScore])
  @@map("threats")
}

model ThreatComponentMapping {
  id          String               @id @default(uuid())
  threatId    String               @map("threat_id")
  componentId String               @map("component_id")
  createdAt   DateTime             @default(now()) @map("created_at")
  component   ThreatModelComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)
  threat      Threat               @relation(fields: [threatId], references: [id], onDelete: Cascade)

  @@unique([threatId, componentId])
  @@map("threat_component_mappings")
}

model ThreatDataFlowMapping {
  id         String              @id @default(uuid())
  threatId   String              @map("threat_id")
  dataFlowId String              @map("data_flow_id")
  createdAt  DateTime            @default(now()) @map("created_at")
  dataFlow   ThreatModelDataFlow @relation(fields: [dataFlowId], references: [id], onDelete: Cascade)
  threat     Threat              @relation(fields: [threatId], references: [id], onDelete: Cascade)

  @@unique([threatId, dataFlowId])
  @@map("threat_data_flow_mappings")
}

model ThreatMitigation {
  id                   String                    @id @default(uuid())
  threatModelId        String                    @map("threat_model_id")
  title                String
  description          String
  type                 String
  implementationStatus String                    @default("planned") @map("implementation_status")
  priority             Int                       @default(0)
  effort               String?
  cost                 String?
  owner                String?
  dueDate              DateTime?                 @map("due_date")
  implementedAt        DateTime?                 @map("implemented_at")
  verifiedAt           DateTime?                 @map("verified_at")
  jiraIssueKey         String?                   @map("jira_issue_key")
  findingIds           String[]                  @map("finding_ids")
  metadata             Json                      @default("{}")
  createdAt            DateTime                  @default(now()) @map("created_at")
  updatedAt            DateTime                  @updatedAt @map("updated_at")
  threats              ThreatMitigationMapping[]
  threatModel          ThreatModel               @relation(fields: [threatModelId], references: [id], onDelete: Cascade)

  @@index([threatModelId])
  @@index([implementationStatus])
  @@map("threat_mitigations")
}

model ThreatMitigationMapping {
  id            String           @id @default(uuid())
  threatId      String           @map("threat_id")
  mitigationId  String           @map("mitigation_id")
  effectiveness String           @default("partial")
  createdAt     DateTime         @default(now()) @map("created_at")
  mitigation    ThreatMitigation @relation(fields: [mitigationId], references: [id], onDelete: Cascade)
  threat        Threat           @relation(fields: [threatId], references: [id], onDelete: Cascade)

  @@unique([threatId, mitigationId])
  @@map("threat_mitigation_mappings")
}

model Sbom {
  id              String              @id @default(uuid())
  tenantId        String              @map("tenant_id")
  repositoryId    String?             @map("repository_id")
  name            String
  version         String              @default("1.0.0")
  format          String
  formatVersion   String              @map("format_version")
  source          String
  componentCount  Int                 @default(0) @map("component_count")
  vulnCount       Int                 @default(0) @map("vuln_count")
  criticalCount   Int                 @default(0) @map("critical_count")
  highCount       Int                 @default(0) @map("high_count")
  mediumCount     Int                 @default(0) @map("medium_count")
  lowCount        Int                 @default(0) @map("low_count")
  createdBy       String              @map("created_by")
  rawContent      String?             @map("raw_content")
  scanId          String?             @map("scan_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  projectId       String?             @map("project_id")
  components      SbomComponent[]
  vulnerabilities SbomVulnerability[]
  project         Project?            @relation(fields: [projectId], references: [id])

  @@index([tenantId])
  @@index([repositoryId])
  @@index([projectId])
  @@map("sboms")
}

model SbomComponent {
  id              String              @id @default(uuid())
  sbomId          String              @map("sbom_id")
  purl            String?
  name            String
  version         String?
  type            String
  supplier        String?
  author          String?
  license         String?
  licenseSpdxId   String?             @map("license_spdx_id")
  description     String?
  checksum        String?
  checksumAlgo    String?             @map("checksum_algo")
  homepage        String?
  downloadUrl     String?             @map("download_url")
  isDirect        Boolean             @default(true) @map("is_direct")
  parentId        String?             @map("parent_id")
  depth           Int                 @default(0)
  scope           String?
  externalRefs    Json                @default("[]") @map("external_refs")
  metadata        Json                @default("{}")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  vulnerabilities SbomComponentVuln[]
  sbom            Sbom                @relation(fields: [sbomId], references: [id], onDelete: Cascade)

  @@index([sbomId])
  @@index([purl])
  @@index([name])
  @@map("sbom_components")
}

model SbomVulnerability {
  id             String              @id @default(uuid())
  sbomId         String              @map("sbom_id")
  cveId          String?             @map("cve_id")
  ghsaId         String?             @map("ghsa_id")
  osvId          String?             @map("osv_id")
  severity       String
  cvssScore      Float?              @map("cvss_score")
  cvssVector     String?             @map("cvss_vector")
  title          String
  description    String?
  recommendation String?
  fixedVersion   String?             @map("fixed_version")
  epssScore      Float?              @map("epss_score")
  isKev          Boolean             @default(false) @map("is_kev")
  publishedAt    DateTime?           @map("published_at")
  references     Json                @default("[]")
  status         String              @default("open")
  ignoredReason  String?             @map("ignored_reason")
  ignoredBy      String?             @map("ignored_by")
  ignoredAt      DateTime?           @map("ignored_at")
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  components     SbomComponentVuln[]
  sbom           Sbom                @relation(fields: [sbomId], references: [id], onDelete: Cascade)

  @@index([sbomId])
  @@index([cveId])
  @@index([severity])
  @@index([status])
  @@map("sbom_vulnerabilities")
}

model SbomComponentVuln {
  id            String            @id @default(uuid())
  componentId   String            @map("component_id")
  vulnId        String            @map("vuln_id")
  createdAt     DateTime          @default(now()) @map("created_at")
  component     SbomComponent     @relation(fields: [componentId], references: [id], onDelete: Cascade)
  vulnerability SbomVulnerability @relation(fields: [vulnId], references: [id], onDelete: Cascade)

  @@unique([componentId, vulnId])
  @@map("sbom_component_vulns")
}

model ContainerRegistry {
  id             String           @id @default(uuid())
  tenantId       String           @map("tenant_id")
  name           String
  type           String
  url            String
  username       String?
  password       String?
  accessToken    String?          @map("access_token")
  awsRegion      String?          @map("aws_region")
  awsAccessKeyId String?          @map("aws_access_key_id")
  awsSecretKey   String?          @map("aws_secret_key")
  isActive       Boolean          @default(true) @map("is_active")
  lastSyncAt     DateTime?        @map("last_sync_at")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  images         ContainerImage[]

  @@index([tenantId])
  @@map("container_registries")
}

model ContainerImage {
  id         String            @id @default(uuid())
  registryId String            @map("registry_id")
  tenantId   String            @map("tenant_id")
  repository String
  tag        String
  digest     String?
  size       BigInt?
  platform   String?
  createdAt  DateTime          @default(now()) @map("created_at")
  updatedAt  DateTime          @updatedAt @map("updated_at")
  registry   ContainerRegistry @relation(fields: [registryId], references: [id], onDelete: Cascade)
  scans      ContainerScan[]

  @@unique([registryId, repository, tag])
  @@index([tenantId])
  @@index([registryId])
  @@map("container_images")
}

model ContainerScan {
  id            String             @id @default(uuid())
  imageId       String             @map("image_id")
  tenantId      String             @map("tenant_id")
  status        String             @default("pending")
  scanner       String
  vulnCount     Int                @default(0) @map("vuln_count")
  criticalCount Int                @default(0) @map("critical_count")
  highCount     Int                @default(0) @map("high_count")
  mediumCount   Int                @default(0) @map("medium_count")
  lowCount      Int                @default(0) @map("low_count")
  layerCount    Int                @default(0) @map("layer_count")
  startedAt     DateTime?          @map("started_at")
  completedAt   DateTime?          @map("completed_at")
  duration      Int?
  errorMessage  String?            @map("error_message")
  rawOutput     Json?              @map("raw_output")
  sbomId        String?            @map("sbom_id")
  createdAt     DateTime           @default(now()) @map("created_at")
  findings      ContainerFinding[]
  image         ContainerImage     @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([imageId])
  @@index([tenantId])
  @@index([status])
  @@map("container_scans")
}

model ContainerFinding {
  id               String        @id @default(uuid())
  scanId           String        @map("scan_id")
  cveId            String?       @map("cve_id")
  severity         String
  title            String
  description      String?
  pkgName          String        @map("pkg_name")
  installedVersion String        @map("installed_version")
  fixedVersion     String?       @map("fixed_version")
  layer            String?
  cvssScore        Float?        @map("cvss_score")
  epssScore        Float?        @map("epss_score")
  isKev            Boolean       @default(false) @map("is_kev")
  status           String        @default("open")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  scan             ContainerScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([scanId])
  @@index([cveId])
  @@index([severity])
  @@map("container_findings")
}

model Environment {
  id            String       @id @default(uuid())
  tenantId      String       @map("tenant_id")
  name          String
  type          String
  description   String?
  kubeConfig    String?      @map("kube_config")
  kubeContext   String?      @map("kube_context")
  namespace     String?
  cloudProvider String?      @map("cloud_provider")
  cloudRegion   String?      @map("cloud_region")
  cloudProject  String?      @map("cloud_project")
  isActive      Boolean      @default(true) @map("is_active")
  lastSyncAt    DateTime?    @map("last_sync_at")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  projectId     String?      @map("project_id")
  deployments   Deployment[]
  project       Project?     @relation(fields: [projectId], references: [id])

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([projectId])
  @@map("environments")
}

model Deployment {
  id            String      @id @default(uuid())
  environmentId String      @map("environment_id")
  tenantId      String      @map("tenant_id")
  repositoryId  String?     @map("repository_id")
  name          String
  version       String?
  image         String?
  imageDigest   String?     @map("image_digest")
  replicas      Int         @default(1)
  status        String      @default("unknown")
  vulnCount     Int         @default(0) @map("vuln_count")
  criticalCount Int         @default(0) @map("critical_count")
  lastScanId    String?     @map("last_scan_id")
  lastSbomId    String?     @map("last_sbom_id")
  labels        Json        @default("{}")
  annotations   Json        @default("{}")
  exposedPorts  Int[]       @default([]) @map("exposed_ports")
  hasIngress    Boolean     @default(false) @map("has_ingress")
  ingressHosts  String[]    @default([]) @map("ingress_hosts")
  deployedAt    DateTime?   @map("deployed_at")
  deployedBy    String?     @map("deployed_by")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  environment   Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@unique([environmentId, name])
  @@index([tenantId])
  @@index([environmentId])
  @@index([repositoryId])
  @@map("deployments")
}

model ProjectComplianceConfig {
  id                String                     @id @default(uuid())
  tenantId          String                     @map("tenant_id")
  projectId         String                     @map("project_id")
  frameworkId       String                     @map("framework_id")
  name              String
  version           String
  enabled           Boolean                    @default(true)
  overallScore      Float?                     @map("overall_score")
  compliantCount    Int                        @default(0) @map("compliant_count")
  partialCount      Int                        @default(0) @map("partial_count")
  nonCompliantCount Int                        @default(0) @map("non_compliant_count")
  notAssessedCount  Int                        @default(0) @map("not_assessed_count")
  lastAssessedAt    DateTime?                  @map("last_assessed_at")
  lastAssessedBy    String?                    @map("last_assessed_by")
  createdAt         DateTime                   @default(now()) @map("created_at")
  updatedAt         DateTime                   @updatedAt @map("updated_at")
  project           Project                    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  controls          ProjectComplianceControl[]

  @@unique([projectId, frameworkId])
  @@index([tenantId])
  @@index([projectId])
  @@map("project_compliance_configs")
}

model ProjectComplianceControl {
  id               String                  @id @default(uuid())
  configId         String                  @map("config_id")
  controlId        String                  @map("control_id")
  name             String
  category         String?
  description      String?
  status           String                  @default("not_assessed")
  evidence         String?
  evidenceUrl      String?                 @map("evidence_url")
  linkedFindingIds String[]                @default([]) @map("linked_finding_ids")
  assessedAt       DateTime?               @map("assessed_at")
  assessedBy       String?                 @map("assessed_by")
  notes            String?
  createdAt        DateTime                @default(now()) @map("created_at")
  updatedAt        DateTime                @updatedAt @map("updated_at")
  config           ProjectComplianceConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, controlId])
  @@index([configId])
  @@index([status])
  @@map("project_compliance_controls")
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

// Penetration Testing / DAST Targets
model PenTestTarget {
  id              String        @id @default(uuid())
  tenantId        String        @map("tenant_id")
  projectId       String?       @map("project_id")
  name            String
  url             String
  type            String        @default("web_application") // web_application, api_endpoint, network_service
  description     String?

  // Authentication
  authType        String?       @map("auth_type") // none, basic, bearer, cookie
  authCredentials Json?         @map("auth_credentials") // encrypted credentials
  authConfig      Json?         @map("auth_config") // legacy: credentials, headers, cookies
  headers         Json?         @default("{}") // custom headers

  // Scan configuration
  defaultScanners   String[]      @default(["nuclei"]) @map("default_scanners")
  defaultScanMode   String        @default("standard") @map("default_scan_mode") // quick, standard, comprehensive
  rateLimitPreset   String        @default("medium") @map("rate_limit_preset") // low, medium, high
  rateLimitRps      Int?          @map("rate_limit_rps") // deprecated: use rateLimitPreset
  excludePaths      String[]      @default([]) @map("exclude_paths")

  // Risk tracking
  riskScore       Int?          @map("risk_score") // 0-100
  lastScanId      String?       @map("last_scan_id")

  isActive        Boolean       @default(true) @map("is_active")
  lastScanAt      DateTime?     @map("last_scan_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  scans           PenTestScan[]

  @@index([tenantId])
  @@index([projectId])
  @@map("pentest_targets")
}

model PenTestScan {
  id                   String           @id @default(uuid())
  tenantId             String           @map("tenant_id")
  targetId             String           @map("target_id")
  status               String           @default("pending") // pending, running, completed, failed, cancelled
  scanners             String[]         @default([]) // sqlmap, nikto, sslyze, zap, nuclei
  config               Json             @default("{}") // scanner-specific config
  scanMode             String           @default("standard") @map("scan_mode") // quick, standard, comprehensive
  scanPhase            String           @default("discovery") @map("scan_phase") // discovery, scanning, complete
  detectedTechnologies String[]         @default([]) @map("detected_technologies") // populated by discovery phase
  crawledUrls          Int              @default(0) @map("crawled_urls") // count of URLs discovered by Katana
  parentScanId         String?          @map("parent_scan_id") // links deep scan to its discovery scan
  startedAt            DateTime?        @map("started_at")
  completedAt          DateTime?        @map("completed_at")
  duration             Int? // seconds
  findingsCount        Int              @default(0) @map("findings_count")
  criticalCount        Int              @default(0) @map("critical_count")
  highCount            Int              @default(0) @map("high_count")
  mediumCount          Int              @default(0) @map("medium_count")
  lowCount             Int              @default(0) @map("low_count")
  infoCount            Int              @default(0) @map("info_count")
  errorMessage         String?          @map("error_message")
  rawOutput            Json?            @map("raw_output")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")
  target               PenTestTarget    @relation(fields: [targetId], references: [id], onDelete: Cascade)
  parentScan           PenTestScan?     @relation("ScanHierarchy", fields: [parentScanId], references: [id])
  childScans           PenTestScan[]    @relation("ScanHierarchy")
  findings             PenTestFinding[]

  @@index([tenantId])
  @@index([targetId])
  @@index([status])
  @@index([parentScanId])
  @@map("pentest_scans")
}

model PenTestFinding {
  id          String      @id @default(uuid())
  scanId      String      @map("scan_id")
  tenantId    String      @map("tenant_id")
  scanner     String // which scanner found this
  ruleId      String      @map("rule_id")
  severity    String // critical, high, medium, low, info
  confidence  String      @default("medium") // high, medium, low
  title       String
  description String?
  url         String? // affected URL/endpoint
  parameter   String? // affected parameter (for injection vulns)
  payload     String? // attack payload used
  evidence    String? // response evidence
  cweIds      String[]    @default([]) @map("cwe_ids")
  cveIds      String[]    @default([]) @map("cve_ids")
  owaspIds    String[]    @default([]) @map("owasp_ids")
  references  Json        @default("[]")
  remediation String?
  status      String      @default("open") // open, confirmed, false_positive, fixed
  verifiedAt  DateTime?   @map("verified_at")
  verifiedBy  String?     @map("verified_by")
  fingerprint String?
  metadata    Json        @default("{}")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  scan        PenTestScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([scanId])
  @@index([tenantId])
  @@index([severity])
  @@index([status])
  @@index([scanner])
  @@map("pentest_findings")
}
