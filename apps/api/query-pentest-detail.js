const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function main() {
  // Get scans with target containing 127.0.0.1 or 3500
  const scans = await prisma.penTestScan.findMany({
    orderBy: { createdAt: 'desc' },
    take: 10,
    include: {
      findings: {
        select: {
          scanner: true,
          severity: true,
          title: true,
          ruleId: true,
        }
      }
    }
  });

  console.log('=== THREATDIVINER PENTEST RESULTS ===\n');

  for (const scan of scans) {
    if (scan.findings.length === 0) continue;

    console.log('--- Scan:', scan.id, '---');
    console.log('Target:', scan.targetUrl || scan.target);
    console.log('Status:', scan.status);
    console.log('Total Findings:', scan.findings.length);

    // Group by scanner
    const byScanner = {};
    for (const f of scan.findings) {
      if (!byScanner[f.scanner]) byScanner[f.scanner] = [];
      byScanner[f.scanner].push(f);
    }

    for (const [scanner, findings] of Object.entries(byScanner)) {
      console.log('\n  ' + scanner.toUpperCase() + ' (' + findings.length + ' findings):');
      for (const f of findings.slice(0, 10)) {
        console.log('    - [' + f.severity + '] ' + (f.title || f.ruleId));
      }
      if (findings.length > 10) {
        console.log('    ... and ' + (findings.length - 10) + ' more');
      }
    }
    console.log('\n');
  }

  // Summary comparison
  console.log('=== COMPARISON WITH EXTERNAL CLI ===\n');
  console.log('External CLI Results:');
  console.log('  Nuclei: 3 findings (info)');
  console.log('  Nikto:  12 findings');
  console.log('  SQLMap: 0 (endpoint not reachable)');
  console.log('  ZAP:    N/A (not installed)');
  console.log('  SSLyze: N/A (HTTP target)\n');

  // Find totals from app
  let appNuclei = 0, appNikto = 0;
  for (const scan of scans) {
    for (const f of scan.findings) {
      if (f.scanner === 'nuclei') appNuclei++;
      if (f.scanner === 'nikto') appNikto++;
    }
  }

  console.log('ThreatDiviner App Results (all scans):');
  console.log('  Nuclei: ' + appNuclei + ' findings');
  console.log('  Nikto:  ' + appNikto + ' findings');
}

main().catch(console.error).finally(() => prisma.$disconnect());
